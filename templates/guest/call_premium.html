{% extends "base.html" %}

{% block title %}Shuttle √áaƒüƒ±r{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/guest-premium.css') }}">
<style>
/* ==================== PREMIUM GUEST CALL PAGE ==================== */
/* Optimized and Enhanced Version - Powered by Erkan ERDEM */

:root {
    /* Merit Hotels Renk Paleti */
    --primary-navy: #1A2B4A;
    --royal-gold: #D4AF37;
    --primary-gradient: linear-gradient(135deg, var(--primary-navy) 0%, #2A3B5A 100%);
    --accent-gradient: linear-gradient(135deg, var(--royal-gold) 0%, #E4BF47 100%);
    --success-color: #2E7D32;
    --error-color: #B71C1C;
    --warning-color: var(--royal-gold);
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
    --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.12);
    --radius-sm: 12px;
    --radius-md: 16px;
    --radius-lg: 24px;
    --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
}

/* ==================== BASE LAYOUT ==================== */
body {
  background: linear-gradient(180deg, #F8F8F8 0%, #E8F4F8 100%);
  min-height: 100vh;
}

.header,
.footer {
    display: none;
}

/* ==================== CONTAINER ==================== */
.guest-call-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: clamp(16px, 4vw, 24px);
    max-width: 540px;
    margin: 0 auto;
}

/* ==================== LOGO SECTION ==================== */
.logo-section {
    text-align: center;
    margin-bottom: 24px;
    margin-top: 20px;
    animation: fadeInDown 0.6s ease-out;
}

/* Location Image Wrapper (Large) */
.location-image-wrapper {
    width: 160px;
    height: 160px;
    margin: 0 auto 16px;
    position: relative;
}

#location-main-image-container {
    width: 100%;
    height: 100%;
    border-radius: 24px;
    overflow: hidden;
    background: transparent;
    box-shadow: none;
    animation: float 3s ease-in-out infinite;
}

#location-main-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#location-main-icon-container {
    width: 100%;
    height: 100%;
    background: transparent;
    border-radius: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: none;
    animation: float 3s ease-in-out infinite;
}

#location-main-icon-container i {
    font-size: 64px;
    color: white;
}

/* Location Name Display */
.location-name-display {
    margin-bottom: 16px;
}

.location-name-display span {
    font-size: clamp(18px, 4.5vw, 22px);
    font-weight: 700;
    color: var(--primary-navy);
    display: block;
}

/* Brand Title Section (Above Location Image) */
.brand-title-section {
    margin-bottom: 16px;
}

.brand-title-text {
    font-size: clamp(20px, 5vw, 26px);
    font-weight: 700;
    color: var(--primary-navy);
    margin: 0;
    letter-spacing: 0.5px;
}

/* Brand Logo Section (Below Location Name) */
.brand-logo-section {
    margin-top: 12px;
}

.small-logo {
    width: 48px;
    height: 48px;
    object-fit: contain;
}

/* ==================== CARDS ==================== */
.qr-card,
.call-form-card {
    background: #FFFFFF;
    border-radius: 20px;
    padding: clamp(24px, 6vw, 40px) clamp(20px, 5vw, 32px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    border: none;
    margin-bottom: 20px;
    animation: fadeInUp 0.6s ease-out 0.2s both;
    transition: all 0.3s var(--transition-smooth);
}

.call-form-card {
    display: none;
}

/* ==================== QR SCANNER ICON ==================== */
.qr-icon-wrapper {
    width: clamp(80px, 20vw, 96px);
    height: clamp(80px, 20vw, 96px);
    margin: 0 auto 24px;
    background: #F9FAFB;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px dashed #E5E7EB;
    animation: scanner-pulse 2.5s ease-in-out infinite;
}

.qr-icon-wrapper i {
    font-size: clamp(36px, 10vw, 48px);
    background: linear-gradient(135deg, var(--primary-navy), var(--royal-gold));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.qr-card h2 {
    font-size: clamp(18px, 4.5vw, 22px);
    font-weight: 700;
    color: #111827;
    margin-bottom: 12px;
    text-align: center;
}

.qr-card p {
    font-size: clamp(13px, 3.2vw, 15px);
    color: #6B7280;
    line-height: 1.6;
    text-align: center;
    margin-bottom: 24px;
}

/* ==================== BUTTONS ==================== */
.btn-primary-modern {
    width: 100%;
    min-height: 56px;
    background: var(--primary-gradient);
    color: white;
    border: none;
    border-radius: 14px;
    font-size: clamp(15px, 4vw, 17px);
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(27, 165, 168, 0.2);
    transition: all 0.3s var(--transition-smooth);
    position: relative;
    overflow: hidden;
    padding: 16px 24px;
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
}

.btn-primary-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(27, 165, 168, 0.25);
}

.btn-primary-modern:active {
    transform: translateY(-1px);
}

.btn-primary-modern:focus-visible {
    outline: 3px solid rgba(27, 165, 168, 0.5);
    outline-offset: 3px;
}

.btn-primary-modern::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.btn-primary-modern:active::before {
    width: 300px;
    height: 300px;
}

/* ==================== INPUT SECTION ==================== */
.input-section {
    margin-bottom: 24px;
}

.input-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.input-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: #F9FAFB;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-navy);
    font-size: 20px;
    border: 1px solid #E5E7EB;
    flex-shrink: 0;
}

.input-label {
    font-size: clamp(14px, 3.5vw, 15px);
    font-weight: 700;
    color: #111827;
    margin: 0;
}

.modern-input {
    width: 100%;
    min-height: 52px;
    border: 2px solid #E5E7EB;
    border-radius: 14px;
    font-size: 16px;
    padding: 14px 16px;
    transition: all 0.3s ease;
    background: #F9FAFB;
}

.modern-input:focus {
    border-color: var(--primary-navy);
    background: white;
    box-shadow: 0 0 0 4px rgba(26, 43, 74, 0.1);
    outline: none;
}

.modern-input::placeholder {
    color: #9CA3AF;
}

/* ==================== REMOVED - Location display moved to logo section ==================== */

/* ==================== FOOTER SECTION ==================== */
.footer-section {
    text-align: center;
    padding: 2rem 0;
    background: #1A2B4A;
    border-top: 2px solid #D4AF37;
    margin-top: 2rem;
    margin-left: calc(-1 * clamp(16px, 4vw, 24px));
    margin-right: calc(-1 * clamp(16px, 4vw, 24px));
    width: calc(100% + 2 * clamp(16px, 4vw, 24px));
    animation: fadeIn 0.6s ease-out 0.4s both;
}

.hotel-name {
    font-size: clamp(14px, 3.5vw, 16px);
    font-weight: 600;
    color: #FFFFFF;
    letter-spacing: 0.5px;
    margin: 0;
}

.powered-by {
    display: none;
}

.brand-name {
    display: none;
}

/* ==================== MODAL STYLES ==================== */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
    padding: 20px;
}

.modal-content-modern {
    background: white;
    border-radius: var(--radius-lg);
    max-width: 500px;
    width: 100%;
    padding: 0;
    box-shadow: 0 24px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    overflow: hidden;
}

.modal-header-modern {
    background: var(--primary-gradient);
    color: white;
    padding: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title-modern {
    font-size: clamp(16px, 4vw, 20px);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0;
}

.modal-close-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.modal-close-btn:focus-visible {
    outline: 2px solid white;
    outline-offset: 2px;
}

.modal-body-modern {
    padding: 24px;
}

/* ==================== QR READER ==================== */
#qr-reader {
    border-radius: var(--radius-md);
    overflow: hidden;
    border: 3px solid var(--primary-navy);
}

.qr-reader-hint {
    text-align: center;
    margin-top: 16px;
    color: #6B7280;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* ==================== ANIMATIONS ==================== */
@keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-12px); }
}

@keyframes pulse-ring {
    0%, 100% {
        transform: scale(1);
        opacity: 0.5;
    }
    50% {
        transform: scale(1.1);
        opacity: 0;
    }
}

@keyframes scanner-pulse {
    0%, 100% {
        border-color: #E5E7EB;
        transform: scale(1);
    }
    50% {
        border-color: var(--primary-navy);
        transform: scale(1.05);
    }
}

@keyframes slideUp {
    from {
        transform: translateY(50px) scale(0.9);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ==================== ACCESSIBILITY ==================== */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

/* ==================== PERFORMANCE OPTIMIZATIONS ==================== */
.logo-wrapper,
.qr-icon-wrapper,
.btn-primary-modern {
    will-change: transform;
}

/* ==================== REDUCED MOTION ==================== */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* ==================== OPTIMIST BRANDING ==================== */
.optimist-branding img {
    transition: opacity 0.3s ease;
}

.optimist-branding:hover img {
    opacity: 1 !important;
}

@media (max-width: 480px) {
    .optimist-branding img {
        height: 20px !important;
    }
    
    .optimist-branding p {
        font-size: 0.6rem !important;
    }
    
    .optimist-branding p:last-child {
        font-size: 0.55rem !important;
    }
}

/* ==================== RESPONSIVE DESIGN ==================== */
@media (max-width: 768px) {
    .guest-call-container {
        padding: 16px;
    }

    .qr-card,
    .call-form-card {
        padding: 20px 16px;
    }
}

/* ==================== DARK MODE SUPPORT ==================== */
/* Dark mode disabled to match status page */

/* ==================== PRINT STYLES ==================== */
@media print {
    .guest-call-container {
        display: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="guest-call-container" data-location-id="{% if location_id %}{{ location_id }}{% endif %}">
    <!-- Location Image & Logo Section -->
    <div class="logo-section">
        <div class="brand-logo-section">
       <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Shuttle Call Logo" class="small-logo">
        </div>
        <!-- Brand Title -->
        <div class="brand-title-section">
            <!-- Small Logo -->
        
           <p class="brand-title-text">      Shuttle Call System</p>  </div>
      
        
        <!-- Location Image (Large) -->
        <div class="location-image-wrapper" id="location-image-wrapper">
            <div id="location-main-image-container" style="display: none;">
                <img id="location-main-image" alt="Lokasyon g√∂rseli">
            </div>
            <div id="location-main-icon-container" style="display: flex;">
                <i class="fas fa-map-marker-alt"></i>
            </div>
        </div>
        
        <!-- Location Name -->
        <div class="location-name-display">
            <span id="location-name-display">Lokasyon y√ºkleniyor...</span>
        </div>
        
        
    </div>

    <!-- Main Content -->
    <div class="content-section">
        <!-- QR Scanner Card -->
        <div class="qr-card" id="qr-scanner-card" {% if location_id %}style="display: none;"{% endif %}>
            <div class="qr-icon-wrapper" role="img" aria-label="QR Kod ƒ∞konu">
                <i class="fas fa-qrcode" aria-hidden="true"></i>
            </div>
            <h2>QR Kod Okutun</h2>
            <p>Bulunduƒüunuz lokasyondaki QR kodu okutarak kolayca shuttle √ßaƒüƒ±rabilirsiniz</p>
            <button
                class="btn-primary-modern"
                onclick="GuestCall.startQRScanner()"
                aria-label="QR kod okuyucuyu ba≈ülat"
                type="button">
                <i class="fas fa-camera" aria-hidden="true"></i>
                <span>QR Kod Okut</span>
            </button>
        </div>

        <!-- Call Form Card (shown after QR scan) -->
        <div class="call-form-card" id="call-form-card" role="region" aria-label="Shuttle √ßaƒüƒ±rma formu" {% if location_id %}style="display: block; opacity: 1; transform: translateY(0);"{% endif %}>
            <!-- Call Button -->
            <button
                class="btn-primary-modern"
                onclick="GuestCall.showConfirmationModal()"
                aria-label="Shuttle √ßaƒüƒ±r"
                style="margin-bottom: 24px;"
                type="button">
                <i class="fas fa-paper-plane" aria-hidden="true"></i>
                <span>Shuttle √áaƒüƒ±r</span>
            </button>

            <!-- Room Number Input -->
            <div class="input-section">
                <div class="input-header">
                    <div class="input-icon" role="img" aria-label="Oda ikonu">
                        <i class="fas fa-door-open" aria-hidden="true"></i>
                    </div>
                    <h3 class="input-label">Oda Numaranƒ±z (Opsiyonel)</h3>
                </div>
                <label for="room-number" class="sr-only">Oda numaranƒ±z (opsiyonel)</label>
                <input
                    type="text"
                    class="modern-input"
                    id="room-number"
                    placeholder="√ñrn: A-101"
                    maxlength="20"
                    aria-label="Oda numaranƒ±z"
                    aria-describedby="room-number-help"
                    autocomplete="off">
                <span id="room-number-help" class="sr-only">Oda numaranƒ±zƒ± girin (opsiyonel)</span>
            </div>

            
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="footer-section">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
            <img src="{{ url_for('static', filename='images/Merit_International.png') }}" 
                 alt="Merit International Hotels & Resorts" 
                 style="height: 50px; width: auto; object-fit: contain;">
            <p class="hotel-name">MERIT INTERNATIONAL HOTELS & RESORTS ¬© 2025 COPYRIGHT</p>
            
            <!-- Optimist Branding -->
            <div class="optimist-branding" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(26, 43, 74, 0.1); width: 100%; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem; opacity: 0.75;">
                    <img src="{{ url_for('static', filename='images/opti.png') }}" 
                         alt="Optimist Bili≈üim & Elektronik" 
                         style="height: 24px; width: auto; object-fit: contain; filter: brightness(0) opacity(0.7);">
                    <div style="text-align: left; line-height: 1.3;">
                        <p style="margin: 0; font-size: 0.65rem; color: #6B7280; font-weight: 500;">Sistem Geli≈ütirme & Teknik Destek</p>
                        <p style="margin: 0; font-size: 0.6rem; color: #9CA3AF; font-weight: 400;">Optimist Bili≈üim & Elektronik</p>
                    </div>
                </div>
            </div>
        </div>
    </footer>
</div>

<!-- QR Scanner Modal -->
<div id="qr-scanner-modal" class="modal-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="qr-modal-title">
    <div class="modal-content-modern">
        <div class="modal-header-modern">
            <h3 class="modal-title-modern" id="qr-modal-title">
                <i class="fas fa-qrcode" aria-hidden="true"></i>
                <span>QR Kod Okut</span>
            </h3>
            <button
                class="modal-close-btn"
                onclick="GuestCall.closeQRScanner()"
                aria-label="Modalƒ± kapat"
                type="button">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
        </div>
        <div class="modal-body-modern">
            <div id="qr-reader" role="region" aria-label="QR kod okuyucu"></div>
            <p class="qr-reader-hint" role="status" aria-live="polite">
                <i class="fas fa-info-circle" aria-hidden="true"></i>
                <span>QR kodu kameranƒ±za g√∂sterin</span>
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- HTML5 QR Code Scanner -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"
        crossorigin="anonymous"></script>

<script>
/**
 * Guest Call Premium - Enhanced JavaScript Module
 * Optimized for performance, accessibility, and maintainability
 * @author Erkan ERDEM
 * @version 2.0.0
 */

const GuestCall = (() => {
    'use strict';

    // ==================== CONSTANTS ====================
    const ENDPOINTS = {
        LOCATIONS: '/api/locations',
        LOCATION_DETAIL: '/api/locations/{id}',
        REQUESTS: '/api/requests'
    };

    const SELECTORS = {
        QR_SCANNER_CARD: 'qr-scanner-card',
        CALL_FORM_CARD: 'call-form-card',
        ROOM_NUMBER: 'room-number',
        LOCATION_DISPLAY: 'location-name-display',
        HOTEL_NAME: 'hotel-name',
        QR_SCANNER_MODAL: 'qr-scanner-modal',
        QR_READER: 'qr-reader'
    };

    const ANIMATION_DURATION = 400;
    const REDIRECT_DELAY = 3000;

    // ==================== STATE ====================
    let state = {
        html5QrCode: null,
        selectedLocationId: null,
        selectedLocationName: null,
        isProcessing: false
    };

    // ==================== UTILITY FUNCTIONS ====================
    const $ = (id) => document.getElementById(id);
    const $$ = (selector) => document.querySelectorAll(selector);

    const getCsrfToken = () => {
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute('content') : '';
    };

    const showElement = (element, display = 'block') => {
        if (element) element.style.display = display;
    };

    const hideElement = (element) => {
        if (element) element.style.display = 'none';
    };

    const fetchJSON = async (url, options = {}) => {
        try {
            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                    ...options.headers
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('Fetch error:', error);
            throw error;
        }
    };

    // ==================== INITIALIZATION ====================
    const initializePage = () => {
        // Flask template'den gelen location_id'yi √∂ncelikli kullan
        const container = document.querySelector('.guest-call-container');
        const templateLocationId = container ? container.dataset.locationId : null;
        
        // Eƒüer template'den gelmemi≈üse URL'den oku
        const urlParams = new URLSearchParams(window.location.search);
        const urlLocationId = urlParams.get('location');
        
        // Template veya URL'den location ID al
        const locationId = templateLocationId || urlLocationId;

        console.log('üîç DEBUG - initializePage:', {
            templateLocationId,
            urlLocationId,
            finalLocationId: locationId,
            willShowForm: !!locationId
        });

        if (locationId) {
            console.log('‚úÖ Location ID bulundu, form g√∂steriliyor:', locationId);
            state.selectedLocationId = parseInt(locationId, 10);
            transitionToCallForm();
            // DOM'un hazƒ±r olmasƒ± i√ßin kƒ±sa bir gecikme
            setTimeout(() => {
                loadLocationInfo(locationId);
            }, 100);
        } else {
            console.log('‚ùå Location ID bulunamadƒ±, QR scanner g√∂steriliyor');
            loadHotelName();
        }
    };

    // ==================== UI TRANSITIONS ====================
    const transitionToCallForm = () => {
        const qrCard = $(SELECTORS.QR_SCANNER_CARD);
        const callCard = $(SELECTORS.CALL_FORM_CARD);

        if (!qrCard || !callCard) return;

        qrCard.style.transition = `all ${ANIMATION_DURATION}ms cubic-bezier(0.4, 0, 0.2, 1)`;
        qrCard.style.opacity = '0';
        qrCard.style.transform = 'translateY(-30px)';

        setTimeout(() => {
            hideElement(qrCard);
            showElement(callCard);

            requestAnimationFrame(() => {
                callCard.style.opacity = '1';
                callCard.style.transform = 'translateY(0)';
            });
        }, ANIMATION_DURATION);
    };

    // ==================== DATA LOADING ====================
    const loadLocationInfo = async (locationId) => {
        const displayEl = $(SELECTORS.LOCATION_DISPLAY);
        if (!displayEl) return;

        updateLocationDisplay('<i class="fas fa-spinner fa-spin"></i> Lokasyon y√ºkleniyor...', '#6B7280', null);

        try {
            // Ensure locationId is integer
            const numericLocationId = parseInt(locationId, 10);
            const url = ENDPOINTS.LOCATION_DETAIL.replace('{id}', numericLocationId);
            
            console.log('üîç DEBUG - loadLocationInfo:', {
                originalLocationId: locationId,
                numericLocationId,
                url
            });
            
            const data = await fetchJSON(url);
            
            console.log('üì° DEBUG - API Response:', data);

            // API response format: {success: true, data: {location: {...}}}
            const location = data.data?.location || data.location;

            if (data.success && location) {
                console.log('‚úÖ Location found:', location);
                console.log('üì∏ Location image (raw):', location.location_image);
                
                state.selectedLocationName = location.name;
                
                // Resim yolunu tam URL'e √ßevir
                let imageUrl = null;
                if (location.location_image) {
                    // Eƒüer relative path ise tam URL yap
                    if (location.location_image.startsWith('/')) {
                        imageUrl = window.location.origin + location.location_image;
                    } else if (location.location_image.startsWith('http')) {
                        // Zaten tam URL
                        imageUrl = location.location_image;
                    } else {
                        // Relative path (static/ ile ba≈ülƒ±yor olabilir)
                        imageUrl = window.location.origin + '/' + location.location_image;
                    }
                    console.log('üì∏ Location image (full URL):', imageUrl);
                }
                
                updateLocationDisplay(`<strong>${location.name}</strong>`, '#1A2B4A', imageUrl);
                console.log('‚úÖ updateLocationDisplay called');
           
            } else {
                console.error('‚ùå Location not found in response:', data);
                updateLocationDisplay('<i class="fas fa-exclamation-circle"></i> Lokasyon bulunamadƒ±', '#E74C3C', null);
            }
        } catch (error) {
            console.error('‚ùå Error loading location:', error);
            updateLocationDisplay('<i class="fas fa-exclamation-circle"></i> Y√ºkleme hatasƒ±', '#E74C3C', null);
        }
    };

    const loadHotelName = async () => {
        try {
            const data = await fetchJSON(ENDPOINTS.LOCATIONS);

            if (data.success && data.data?.items?.length > 0) {
                const hotelNameEl = $(SELECTORS.HOTEL_NAME);
                if (hotelNameEl) {
                    hotelNameEl.textContent = 'Shuttle Call System';
                }
            }
        } catch (error) {
            console.error('Error loading hotel:', error);
        }
    };

    // ==================== UI UPDATES ====================
    const updateLocationDisplay = (content, color, locationImage = null) => {
        console.log('üîß updateLocationDisplay called with:', {content, color, locationImage: locationImage ? 'YES' : 'NO'});
        
        const nameDisplay = document.getElementById('location-name-display');
        const mainImageContainer = document.getElementById('location-main-image-container');
        const mainImage = document.getElementById('location-main-image');
        const mainIconContainer = document.getElementById('location-main-icon-container');
        
        console.log('üîç Elements found:', {
            nameDisplay: !!nameDisplay,
            mainImageContainer: !!mainImageContainer,
            mainImage: !!mainImage,
            mainIconContainer: !!mainIconContainer
        });
        
        if (nameDisplay) {
            nameDisplay.innerHTML = content;
            nameDisplay.style.color = color;
            console.log('‚úÖ Name updated:', nameDisplay.innerHTML);
        } else {
            console.error('‚ùå nameDisplay not found!');
        }
        
        // B√ºy√ºk g√∂rsel varsa g√∂ster, yoksa icon g√∂ster
        if (locationImage && locationImage.trim() !== '' && mainImageContainer && mainImage && mainIconContainer) {
            console.log('üñºÔ∏è Setting image src:', locationImage);
            
            // √ñnce icon g√∂ster, resim y√ºklenince deƒüi≈ütir
            mainImageContainer.style.display = 'none';
            mainIconContainer.style.display = 'flex';
            
            mainImage.onerror = () => {
                console.warn('‚ö†Ô∏è Image failed to load, using icon fallback:', locationImage);
                mainImageContainer.style.display = 'none';
                mainIconContainer.style.display = 'flex';
            };
            
            mainImage.onload = () => {
                console.log('‚úÖ Image loaded successfully');
                mainImageContainer.style.display = 'block';
                mainIconContainer.style.display = 'none';
            };
            
            // Resmi y√ºkle - √∂nce icon g√∂ster
            mainImage.src = locationImage;
        } else {
            // Resim yoksa icon g√∂ster
            if (mainImageContainer && mainIconContainer) {
                mainImageContainer.style.display = 'none';
                mainIconContainer.style.display = 'flex';
                console.log('‚úÖ Icon displayed (no image)');
            }
        }
    };

   
    // ==================== QR SCANNER ====================
    const startQRScanner = async () => {
        const modal = $(SELECTORS.QR_SCANNER_MODAL);
        if (!modal) return;

        showElement(modal, 'flex');

        try {
            state.html5QrCode = new Html5Qrcode(SELECTORS.QR_READER);

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            await state.html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError
            );
        } catch (err) {
            console.error('QR Scanner error:', err);
            showToast('Kamera eri≈üimi reddedildi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan kamera iznini kontrol edin.', 'error');
            closeQRScanner();
        }
    };

    const onScanSuccess = (decodedText) => {
        console.log('QR Code scanned:', decodedText);

        if (state.html5QrCode) {
            state.html5QrCode.stop()
                .then(() => {
                    closeQRScanner();
                    processQRCode(decodedText);
                })
                .catch(err => {
                    console.error('Error stopping scanner:', err);
                    closeQRScanner();
                    processQRCode(decodedText);
                });
        }
    };

    const onScanError = (errorMessage) => {
        // Silently handle scan errors (normal during scanning)
    };

    const closeQRScanner = () => {
        const modal = $(SELECTORS.QR_SCANNER_MODAL);

        if (state.html5QrCode) {
            state.html5QrCode.stop()
                .then(() => state.html5QrCode.clear())
                .catch(err => console.error('Error clearing scanner:', err))
                .finally(() => {
                    state.html5QrCode = null;
                });
        }

        if (modal) {
            modal.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => {
                hideElement(modal);
                modal.style.animation = '';
            }, 300);
        }
    };

    const processQRCode = async (qrData) => {
        // URL format - redirect directly
        if (qrData.startsWith('http://') || qrData.startsWith('https://')) {
            console.log('URL format detected, redirecting...');
            showLoadingOverlay('Y√∂nlendiriliyor...');
            window.location.href = qrData;
            return;
        }

        // Legacy LOC format
        if (qrData.startsWith('LOC')) {
            console.log('Legacy LOC format detected');
            showLoadingOverlay('Lokasyon doƒürulanƒ±yor...');

            try {
                const data = await fetchJSON(ENDPOINTS.LOCATIONS);
                hideLoadingOverlay();

                if (data.success && data.data?.items) {
                    const location = data.data.items.find(loc => loc.qr_code_data === qrData);

                    if (location) {
                        state.selectedLocationId = location.id;
                        state.selectedLocationName = location.name;
                        transitionToCallForm();
                        loadLocationInfo(location.id);
                        showToast(`Lokasyon se√ßildi: ${location.name}`, 'success');
                    } else {
                        showToast('Lokasyon bulunamadƒ±', 'error');
                    }
                } else {
                    showToast('Lokasyon y√ºklenemedi', 'error');
                }
            } catch (error) {
                hideLoadingOverlay();
                console.error('Error loading locations:', error);
                showToast('Bir hata olu≈ütu', 'error');
            }
            return;
        }

        // Invalid format
        console.error('Invalid QR code format:', qrData);
        showToast('Ge√ßersiz QR kod formatƒ±', 'error');
    };

    // ==================== REQUEST SUBMISSION ====================
    const showConfirmationModal = () => {
        if (!state.selectedLocationId) {
            showToast('L√ºtfen √∂nce QR kod okutun', 'error');
            return;
        }

        if (state.isProcessing) return;

        const roomNumber = $(SELECTORS.ROOM_NUMBER)?.value || '';
        const locationName = state.selectedLocationName || 'Se√ßili Lokasyon';

        const roomInfo = roomNumber
            ? `<div class="confirm-detail">
                   <i class="fas fa-door-open"></i>
                   <span><strong>Oda:</strong> ${escapeHtml(roomNumber)}</span>
               </div>`
            : '';

        const modal = createConfirmationModal(locationName, roomInfo);
        document.body.appendChild(modal);

        setupModalHandlers(modal);
    };

    const createConfirmationModal = (locationName, roomInfo) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.setAttribute('role', 'dialog');
        overlay.setAttribute('aria-modal', 'true');
        overlay.setAttribute('aria-labelledby', 'confirm-modal-title');

        overlay.innerHTML = `
            <div style="
                background: white;
                border-radius: 24px;
                max-width: 480px;
                width: 100%;
                padding: 32px 24px;
                box-shadow: 0 24px 60px rgba(0, 0, 0, 0.3);
                animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            ">
                <style>
                    .confirm-detail {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 14px 16px;
                        background: #F9FAFB;
                        border-radius: 12px;
                        font-size: 15px;
                        color: #334155;
                        margin-bottom: 10px;
                    }
                    .confirm-detail i {
                        width: 24px;
                        color: var(--primary-navy);
                        font-size: 18px;
                        text-align: center;
                    }
                    .confirm-btn {
                        padding: 16px 24px;
                        border: none;
                        border-radius: 14px;
                        font-size: 16px;
                        font-weight: 700;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        flex: 1;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                    }
                    .confirm-btn-yes {
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
                    }
                    .confirm-btn-yes:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
                    }
                    .confirm-btn-no {
                        background: #F3F4F6;
                        color: #6B7280;
                    }
                    .confirm-btn-no:hover {
                        background: #E5E7EB;
                    }
                </style>

                <div style="text-align: center;">
                    <div style="
                        width: 96px;
                        height: 96px;
                        margin: 0 auto 20px;
                        background: linear-gradient(135deg, #F97316 0%, #EA580C 100%);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 12px 24px rgba(249, 115, 22, 0.3);
                    ">
                        <i class="fas fa-question" style="font-size: 48px; color: white;"></i>
                    </div>

                    <h3 id="confirm-modal-title" style="
                        font-size: 24px;
                        font-weight: 700;
                        color: #111827;
                        margin-bottom: 12px;
                    ">
                        Shuttle √áaƒüƒ±rmak ƒ∞stiyor musunuz?
                    </h3>

                    <p style="
                        font-size: 15px;
                        color: #6B7280;
                        margin-bottom: 24px;
                    ">
                        Talebinizi onaylayƒ±n
                    </p>

                    <div style="
                        background: linear-gradient(135deg, rgba(27, 165, 168, 0.08), rgba(242, 140, 56, 0.08));
                        border-radius: 16px;
                        padding: 20px;
                        margin-bottom: 24px;
                        border: 2px solid rgba(27, 165, 168, 0.2);
                        text-align: left;
                    ">
                        <div class="confirm-detail">
                            <i class="fas fa-map-marker-alt"></i>
                            <span><strong>Lokasyon:</strong> ${escapeHtml(locationName)}</span>
                        </div>
                        ${roomInfo}
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button class="confirm-btn confirm-btn-no" data-action="cancel" type="button">
                            <i class="fas fa-times"></i>
                            <span>ƒ∞ptal</span>
                        </button>
                        <button class="confirm-btn confirm-btn-yes" data-action="confirm" type="button">
                            <i class="fas fa-check"></i>
                            <span>Evet, √áaƒüƒ±r</span>
                        </button>
                    </div>
                </div>
            </div>
        `;

        return overlay;
    };

    const setupModalHandlers = (modal) => {
        const confirmBtn = modal.querySelector('[data-action="confirm"]');
        const cancelBtn = modal.querySelector('[data-action="cancel"]');

        const closeModal = () => {
            modal.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => modal.remove(), 300);
        };

        confirmBtn?.addEventListener('click', () => {
            closeModal();
            submitRequest();
        });

        cancelBtn?.addEventListener('click', closeModal);

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // Trap focus in modal
        const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        modal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            } else if (e.key === 'Tab') {
                if (e.shiftKey && document.activeElement === firstElement) {
                    e.preventDefault();
                    lastElement.focus();
                } else if (!e.shiftKey && document.activeElement === lastElement) {
                    e.preventDefault();
                    firstElement.focus();
                }
            }
        });

        // Focus first button
        requestAnimationFrame(() => firstElement?.focus());
    };

    const submitRequest = async () => {
        if (state.isProcessing) return;

        const roomNumber = $(SELECTORS.ROOM_NUMBER)?.value || '';

        if (!state.selectedLocationId) {
            showToast('L√ºtfen √∂nce QR kod okutun', 'error');
            return;
        }

        state.isProcessing = true;
        showLoadingOverlay('Shuttle √ßaƒürƒ±lƒ±yor...');

        try {
            const data = await fetchJSON(ENDPOINTS.REQUESTS, {
                method: 'POST',
                body: JSON.stringify({
                    location_id: state.selectedLocationId,
                    room_number: roomNumber || null
                })
            });

            hideLoadingOverlay();

            if (data.success && data.request) {
                showSuccessNotification(data.request.id);
            } else {
                showToast(data.error || 'Talep olu≈üturulamadƒ±', 'error');
            }
        } catch (error) {
            hideLoadingOverlay();
            console.error('Request submission error:', error);
            showToast('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
        } finally {
            state.isProcessing = false;
        }
    };

    const showSuccessNotification = (requestId) => {
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.setAttribute('role', 'alert');
        overlay.setAttribute('aria-live', 'assertive');

        overlay.innerHTML = `
            <div style="
                background: white;
                border-radius: 24px;
                max-width: 480px;
                width: 100%;
                padding: 32px 24px;
                box-shadow: 0 24px 60px rgba(0, 0, 0, 0.3);
                animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                text-align: center;
            ">
                <div style="
                    width: 96px;
                    height: 96px;
                    margin: 0 auto 20px;
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 12px 24px rgba(16, 185, 129, 0.3);
                ">
                    <i class="fas fa-check" style="font-size: 48px; color: white;"></i>
                </div>

                <h3 style="
                    font-size: 24px;
                    font-weight: 700;
                    color: #111827;
                    margin-bottom: 12px;
                ">
                    ‚úÖ Talebiniz Alƒ±ndƒ±!
                </h3>

                <p style="
                    font-size: 15px;
                    color: #6B7280;
                    line-height: 1.6;
                    margin-bottom: 24px;
                ">
                    Shuttle √ßaƒürƒ±nƒ±z ba≈üarƒ±yla g√∂nderildi.<br>
                    Durumunu takip edebilirsiniz.
                </p>

                <div style="
                    background: linear-gradient(135deg, #FEF3C7, #FDE68A);
                    border-left: 4px solid #F59E0B;
                    padding: 16px 20px;
                    border-radius: 12px;
                    margin-bottom: 20px;
                ">
                    <p style="
                        margin: 0;
                        color: #92400E;
                        font-size: 14px;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                    ">
                        <i class="fas fa-info-circle"></i>
                        <span>Y√∂nlendiriliyorsunuz...</span>
                    </p>
                </div>

                <div style="
                    width: 48px;
                    height: 48px;
                    margin: 0 auto;
                    border: 3px solid rgba(26, 43, 74, 0.2);
                    border-top-color: var(--primary-navy);
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                "></div>
            </div>
        `;

        document.body.appendChild(overlay);

        // Redirect after delay
        setTimeout(() => {
            window.location.href = `/guest/status/${requestId}`;
        }, REDIRECT_DELAY);
    };

    // ==================== UTILITY MODALS ====================
    const showLoadingOverlay = (message) => {
        const existing = $('loading-overlay-custom');
        if (existing) existing.remove();

        const overlay = document.createElement('div');
        overlay.id = 'loading-overlay-custom';
        overlay.className = 'modal-overlay';
        overlay.setAttribute('role', 'alert');
        overlay.setAttribute('aria-live', 'assertive');
        overlay.setAttribute('aria-busy', 'true');

        overlay.innerHTML = `
            <div style="text-align: center;">
                <div style="
                    width: 64px;
                    height: 64px;
                    margin: 0 auto 20px;
                    border: 4px solid rgba(26, 43, 74, 0.2);
                    border-top-color: var(--primary-navy);
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                "></div>
                <p style="
                    color: white;
                    font-size: 16px;
                    font-weight: 600;
                    margin: 0;
                ">${escapeHtml(message)}</p>
            </div>
        `;

        document.body.appendChild(overlay);
    };

    const hideLoadingOverlay = () => {
        const overlay = $('loading-overlay-custom');
        if (overlay) {
            overlay.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => overlay.remove(), 300);
        }
    };

    const showToast = (message, type = 'info') => {
        // Try to use global toast if available
        if (typeof ShuttleCall !== 'undefined' && ShuttleCall.Utils?.showToast) {
            ShuttleCall.Utils.showToast(message, type);
            return;
        }

        // Fallback to custom toast
        const colors = {
            success: '#10b981',
            error: '#ef4444',
            warning: '#f59e0b',
            info: '#3b82f6'
        };

        const toast = document.createElement('div');
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${colors[type] || colors.info};
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            font-size: 15px;
            font-weight: 600;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
        `;

        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    };

    // ==================== HELPER FUNCTIONS ====================
    const escapeHtml = (text) => {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m])
  };
    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', initializePage);

    // ==================== PUBLIC API ====================
    return {
        startQRScanner,
        closeQRScanner,
        showConfirmationModal
    };
})();

// Add keyframe animations
const animationStyles = document.createElement('style');
animationStyles.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`;
document.head.appendChild(animationStyles);
</script>
{% endblock %}
