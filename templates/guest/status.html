{% extends "base.html" %}

{% block title %}Talep Durumu{% endblock %}

{% block extra_css %}
<style>
    .header {
        display: none;
    }
    /* Keep footer visible */
    .status-container {
        min-height: calc(100vh - 200px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-xl) var(--spacing-md);
        background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%);
    }

    .status-card {
        width: 100%;
        max-width: 600px;
        box-shadow: var(--shadow-xl);
    }

    .status-icon {
        font-size: 4rem;
        margin: 2rem 0;
    }

    .spinner {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 2rem auto;
    }

    .spinner::before {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top-color: #1BA5A8;
        border-right-color: #D4AF37;
        border-radius: 50%;
        animation: spinLoader 1s linear infinite;
    }

    .spinner::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60%;
        height: 60%;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-bottom-color: #1BA5A8;
        border-left-color: #D4AF37;
        border-radius: 50%;
        animation: spinLoader 0.8s linear infinite reverse;
    }

    @keyframes spinLoader {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .progress-ring {
        width: 150px;
        height: 150px;
        margin: 2rem auto;
    }

    /* Pulse animation for accepted status */
    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.5);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="status-container">
    <div class="status-card card">
        <div class="card-header text-center" style="background: var(--primary-color); color: white;">
            <h2><i class="fas fa-route"></i> Talep Durumu</h2>
            <span id="status-badge" class="badge badge-warning">YÃ¼kleniyor...</span>
        </div>

        <div class="card-body text-center">
            <!-- Pending Status -->
            <div id="status-PENDING" class="status-view">
                <div class="spinner"></div>
                <h3>Shuttle Ã§aÄŸrÄ±lÄ±yor...</h3>
                <p class="text-muted">LÃ¼tfen bekleyin, size en yakÄ±n shuttle yÃ¶nlendirilecek</p>
                <div class="alert alert-info mt-3" style="font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Bilgi:</strong> Talebiniz 1 saat iÃ§inde yanÄ±tlanmazsa otomatik olarak "YanÄ±tlanmadÄ±" olarak iÅŸaretlenecektir.
                </div>
            </div>

            <!-- Accepted Status -->
            <div id="status-accepted" class="status-view d-none">
                <div style="text-align: center; padding: 2rem 1rem;">
                    <!-- Animated Icon -->
                    <div style="
                        width: 120px;
                        height: 120px;
                        margin: 0 auto 1.5rem;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
                        animation: pulse 2s infinite;
                    ">
                        <i class="fas fa-shuttle-van" style="font-size: 3rem; color: white;"></i>
                    </div>
                    
                    <h2 style="
                        font-size: 1.75rem;
                        font-weight: 700;
                        color: #10b981;
                        margin-bottom: 1rem;
                    ">
                        ðŸŽ‰ Shuttle Yolda!
                    </h2>
                    
                    <div id="shuttle-info" style="
                        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                        border: 2px solid #10b981;
                        border-radius: 16px;
                        padding: 1.5rem;
                        margin: 1.5rem 0;
                        text-align: left;
                    ">
                        <p style="
                            font-size: 1.125rem;
                            color: #065f46;
                            line-height: 1.6;
                            margin: 0;
                        ">
                            <strong>Talebiniz kabul edildi!</strong><br>
                            <span id="shuttle-code" style="font-size: 1.5rem; font-weight: 700;"></span> 
                            shuttle'Ä± size doÄŸru geliyor.<br><br>
                            Shuttle'Ä±nÄ±z mÃ¼mkÃ¼n olan en kÄ±sa sÃ¼rede sizi istediÄŸiniz noktaya ulaÅŸtÄ±racaktÄ±r.
                        </p>
                    </div>
                    
                    <div style="
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 0.5rem;
                        color: #6b7280;
                        font-size: 0.875rem;
                        margin-top: 1rem;
                    ">
                        <i class="fas fa-clock"></i>
                        <span>LÃ¼tfen bekleyin...</span>
                    </div>
                </div>
            </div>

            <!-- Completed Status -->
            <div id="status-completed" class="status-view d-none">
                <div style="text-align: center; padding: 2rem 1rem;">
                    <!-- Success Icon -->
                    <div style="
                        width: 120px;
                        height: 120px;
                        margin: 0 auto 1.5rem;
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 8px 24px rgba(245, 158, 11, 0.3);
                    ">
                        <i class="fas fa-check-circle" style="font-size: 3.5rem; color: white;"></i>
                    </div>
                    
                    <h2 style="
                        font-size: 1.75rem;
                        font-weight: 700;
                        color: #d97706;
                        margin-bottom: 1rem;
                    ">
                        âœ¨ Shuttle'Ä±nÄ±z Geldi!
                    </h2>
                    
                    <p style="
                        font-size: 1.125rem;
                        color: #6b7280;
                        line-height: 1.6;
                        margin: 1rem 0;
                    ">
                        Hizmetimizi kullandÄ±ÄŸÄ±nÄ±z iÃ§in teÅŸekkÃ¼r ederiz.<br>
                        Ä°yi gÃ¼nler dileriz! ðŸŒŸ
                    </p>
                    
                    <div id="timing-info" style="
                        background: #fef3c7;
                        border: 2px solid #f59e0b;
                        border-radius: 12px;
                        padding: 1rem;
                        margin-top: 1.5rem;
                        display: inline-block;
                    "></div>
                </div>
            </div>

            <!-- Cancelled Status -->
            <div id="status-cancelled" class="status-view d-none">
                <i class="fas fa-times-circle status-icon" style="color: var(--danger-color);"></i>
                <h3>Talep Ä°ptal Edildi</h3>
                <p class="text-muted">Ä°sterseniz yeni bir talep oluÅŸturabilirsiniz</p>
            </div>

            <!-- Location Info -->
            <div id="location-info" class="mt-3"></div>
        </div>

        <div class="card-footer text-center">
            <button id="new-request-btn" class="btn btn-primary d-none" onclick="newRequest()">
                <i class="fas fa-plus"></i> Yeni Talep
            </button>
        </div>
    </div>
</div>

<!-- Footer Section -->
<footer class="footer-section" style="background: #1A2B4A; border-top: 2px solid #D4AF37; padding: 2rem 0; text-align: center; margin-top: 2rem;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
        <img src="{{ url_for('static', filename='images/Merit_International.png') }}" 
             alt="Merit International Hotels & Resorts" 
             style="height: 50px; width: auto; object-fit: contain;">
        <p style="font-size: 14px; font-weight: 600; color: #FFFFFF; letter-spacing: 0.5px; margin: 0;">
            MERIT INTERNATIONAL HOTELS & RESORTS Â© 2025 COPYRIGHT
        </p>
    </div>
</footer>
{% endblock %}

{% block extra_js %}
<script>
    const requestId = {{ request_id }};
    let socket = null;
    let pollInterval = null;

    document.addEventListener( 'DOMContentLoaded', () => {
        initStatusTracking();
    } );

    function initStatusTracking() {
        // Initialize Socket.IO directly
        if (typeof io === 'undefined') {
            console.error('Socket.IO not loaded');
            // Fallback to polling only
            loadRequestStatus();
            pollInterval = setInterval( loadRequestStatus, 3000 );
            return;
        }
        
        socket = io({
            transports: ['polling', 'websocket'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5
        });

        socket.on( 'connect', () => {
            console.log( 'Socket connected for request:', requestId );
            // Join request room
            socket.emit( 'join_request', { request_id: requestId } );
        } );
        
        socket.on( 'joined_request', (data) => {
            console.log('Joined request room:', data);
        } );

        // Listen to status updates
        socket.on( 'request_accepted', ( data ) => {
            console.log('Received request_accepted event:', data);
            if ( data.request_id === requestId ) {
                console.log('Request accepted! Updating status...');
                updateStatus( 'accepted', data );
                // Show acceptance notification
                showAcceptanceNotification( data );
            } else {
                console.log('Request ID mismatch:', data.request_id, 'vs', requestId);
            }
        } );

        socket.on( 'request_completed', ( data ) => {
            if ( data.request_id === requestId ) {
                updateStatus( 'completed', data );
            }
        } );

        socket.on( 'request_cancelled', ( data ) => {
            if ( data.request_id === requestId ) {
                updateStatus( 'cancelled', data );
            }
        } );

        // Start polling as backup
        loadRequestStatus();
        pollInterval = setInterval( loadRequestStatus, 5000 );
    }

    async function loadRequestStatus() {
        try {
            const response = await fetch( `/api/requests/${requestId}` );
            const data = await response.json();

            if ( data.success && data.request ) {
                console.log('Polling - current status:', data.request.status);
                updateStatus( data.request.status, data.request );
            } else {
                console.error('Failed to load request status:', data);
            }
        } catch ( error ) {
            console.error( 'Error loading request status:', error );
        }
    }

    function updateStatus( status, data ) {
        console.log('Updating status to:', status, 'with data:', data);
        
        // Hide all status views
        document.querySelectorAll( '.status-view' ).forEach( el => el.classList.add( 'd-none' ) );

        // Show current status view
        const statusView = document.getElementById( `status-${status}` );
        if ( statusView ) {
            statusView.classList.remove( 'd-none' );
            console.log('Status view updated to:', status);
        } else {
            console.error('Status view not found for:', status);
        }

        // Update badge
        const badge = document.getElementById( 'status-badge' );
        if ( badge ) {
            badge.className = `badge ${getBadgeClass( status )}`;
            badge.textContent = getStatusText( status );
        }

        // Update specific info
        if ( status === 'accepted' && data.buggy ) {
            const shuttleCode = document.getElementById( 'shuttle-code' );
            if ( shuttleCode ) {
                const icon = data.buggy.icon || 'ðŸš—';
                const code = data.buggy.code || 'Shuttle';
                shuttleCode.innerHTML = `${icon} ${code}`;
            }
        }

        if ( status === 'completed' && data.response_time_seconds ) {
            const timingInfo = document.getElementById( 'timing-info' );
            if ( timingInfo ) {
                const minutes = Math.floor( data.response_time_seconds / 60 );
                timingInfo.innerHTML = `
                    <strong><i class="fas fa-clock"></i> Toplam SÃ¼re:</strong> ${minutes} dakika
                `;
            }
        }

        // Update buttons
        const newRequestBtn = document.getElementById( 'new-request-btn' );

        if ( ['completed', 'cancelled'].includes( status ) ) {
            if ( newRequestBtn ) newRequestBtn.classList.remove( 'd-none' );
            // Stop polling
            if ( pollInterval ) {
                clearInterval( pollInterval );
            }
        }

        // Show location info
        if ( data.location ) {
            const locationInfo = document.getElementById( 'location-info' );
            if ( locationInfo ) {
                locationInfo.innerHTML = `
                    <small class="text-muted">
                        <i class="fas fa-map-marker-alt"></i> ${data.location.name}
                        ${data.room_number ? ` â€¢ Oda: ${data.room_number}` : ''}
                    </small>
                `;
            }
        }
    }

    function newRequest() {
        window.location.href = '/guest/call';
    }

    function getBadgeClass( status ) {
        const map = {
            'PENDING': 'badge-warning',
            'accepted': 'badge-info',
            'completed': 'badge-success',
            'cancelled': 'badge-danger'
        };
        return map[status] || 'badge-secondary';
    }

    function getStatusText( status ) {
        const map = {
            'PENDING': 'Bekliyor',
            'accepted': 'Kabul Edildi',
            'completed': 'TamamlandÄ±',
            'cancelled': 'Ä°ptal Edildi'
        };
        return map[status] || status;
    }

    function showAcceptanceNotification( data ) {
        // Get shuttle code
        const shuttleCode = data.buggy?.code || 'Shuttle';
        const driverName = data.driver?.full_name || '';
        
        // Create notification message
        let message = `ðŸŽ‰ Talebiniz ${shuttleCode} numaralÄ± shuttle tarafÄ±ndan kabul edildi!`;
        if ( driverName ) {
            message += `\n\nSÃ¼rÃ¼cÃ¼: ${driverName}`;
        }
        message += '\n\nShuttle size doÄŸru geliyor...';
        
        // Show alert notification
        alert( message );
        
        // Play notification sound
        playAcceptanceSound();
        
        // Vibrate if supported
        if ( window.navigator && window.navigator.vibrate ) {
            window.navigator.vibrate( [200, 100, 200] );
        }
        
        // Show browser notification if permitted
        if ( 'Notification' in window && Notification.permission === 'granted' ) {
            new Notification( 'Shuttle Kabul Edildi! ðŸŽ‰', {
                body: `${shuttleCode} size doÄŸru geliyor`,
                icon: '/static/icons/icon-192x192.png',
                badge: '/static/icons/icon-96x96.png',
                vibrate: [200, 100, 200]
            } );
        }
    }

    function playAcceptanceSound() {
        try {
            // Use Web Audio API to generate success sound
            const audioContext = new ( window.AudioContext || window.webkitAudioContext )();
            
            // Play ascending tones for success
            const frequencies = [523, 659, 784]; // C, E, G (major chord)
            
            frequencies.forEach( ( freq, index ) => {
                setTimeout( () => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect( gainNode );
                    gainNode.connect( audioContext.destination );
                    
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime( 0, audioContext.currentTime );
                    gainNode.gain.linearRampToValueAtTime( 0.2, audioContext.currentTime + 0.01 );
                    gainNode.gain.exponentialRampToValueAtTime( 0.01, audioContext.currentTime + 0.3 );
                    
                    oscillator.start( audioContext.currentTime );
                    oscillator.stop( audioContext.currentTime + 0.3 );
                }, index * 150 );
            } );
        } catch ( error ) {
            console.error( 'Error playing acceptance sound:', error );
        }
    }
</script>
{% endblock %}