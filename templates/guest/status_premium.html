{% extends "base.html" %}

{% block title %}Talep Durumu{% endblock %}

{% block extra_css %}
<style>
/* ==================== MODERN STATUS PAGE ==================== */
:root {
    --primary-navy: #1A2B4A;
    --royal-gold: #D4AF37;
    --success-green: #27AE60;
    --bg-white: #FFFFFF;
    --bg-light: #F8F9FA;
    --text-dark: #1A2B4A;
    --text-muted: #6B7280;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
}

body {
    background: var(--bg-white);
    min-height: 100vh;
    margin: 0;
    padding: 0;
}

/* Hide base template elements */
.header, .navbar, header, nav, .mobile-menu-toggle, .connection-indicator {
    display: none !important;
}

.main-content {
    padding: 0 !important;
    margin: 0 !important;
}

/* Container */
.status-container {
    max-width: 540px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Status Card */
.status-card {
    background: var(--bg-white);
    border-radius: 20px;
    padding: 32px 24px;
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    text-align: center;
}

.status-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    background: linear-gradient(135deg, var(--primary-navy), #2A3B5A);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 36px;
}

.status-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 12px;
}

.status-message {
    font-size: 15px;
    color: var(--text-muted);
    line-height: 1.6;
    margin-bottom: 32px;
}

/* Timeline Steps */
.timeline {
    margin: 32px 0;
}

.timeline-step {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 24px;
    position: relative;
}

.timeline-step:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 19px;
    top: 40px;
    width: 2px;
    height: calc(100% + 8px);
    background: #E5E7EB;
}

.timeline-step.completed::after {
    background: var(--royal-gold);
}

.timeline-dot {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #E5E7EB;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    z-index: 1;
}

.timeline-step.completed .timeline-dot {
    background: linear-gradient(135deg, var(--royal-gold), #E4BF47);
    color: white;
}

.timeline-content {
    flex: 1;
    text-align: left;
    padding-top: 8px;
}

.timeline-label {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 4px;
}

.timeline-time {
    font-size: 13px;
    color: var(--text-muted);
}

/* Info Grid */
.info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin: 24px 0;
}

.info-box {
    background: var(--bg-light);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
}

.info-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
}

.info-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-dark);
}

/* Driver Info */
.driver-info {
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(228, 191, 71, 0.05));
    border-radius: 16px;
    padding: 20px;
    margin: 24px 0;
    display: none;
}

.driver-info.show {
    display: block;
}

.driver-details {
    display: flex;
    align-items: center;
    gap: 16px;
}

.driver-avatar {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, var(--primary-navy), #2A3B5A);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
}

.driver-text h4 {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-dark);
    margin: 0 0 4px 0;
}

.driver-text p {
    font-size: 14px;
    color: var(--text-muted);
    margin: 0;
}

/* Completed Message */
.completed-box {
    background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(46, 204, 113, 0.05));
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    margin: 24px 0;
    display: none;
}

.completed-box.show {
    display: block;
}

/* Notification Banner */
.notification-banner {
    background: linear-gradient(135deg, var(--primary-navy), #2A3B5A);
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    display: none;
}

.notification-banner.show {
    display: flex;
    align-items: center;
    gap: 12px;
}

.notification-banner button {
    background: var(--royal-gold);
    color: var(--primary-navy);
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
}

/* Footer */
.status-footer {
    margin-top: auto;
    padding: 24px 0;
    text-align: center;
}

.footer-logo {
    height: 40px;
    margin-bottom: 12px;
}

.footer-text {
    font-size: 12px;
    color: var(--text-muted);
    margin: 8px 0;
}

.optimist-brand {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #E5E7EB;
}

.optimist-brand img {
    height: 20px;
    opacity: 0.6;
}

.optimist-brand span {
    font-size: 11px;
    color: var(--text-muted);
}

/* Button */
.btn-primary {
    background: linear-gradient(135deg, var(--primary-navy), #2A3B5A);
    color: white;
    border: none;
    padding: 14px 24px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 15px;
    width: 100%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary:hover {
    opacity: 0.9;
}
</style>
{% endblock %}

{% block content %}
<div class="status-container">
    <!-- Notification Permission Banner -->
    <div id="notification-banner" class="notification-banner">
        <i class="fas fa-bell"></i>
        <div style="flex: 1;">
            <strong>Bildirim İzni</strong>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;">Shuttle geldiğinde bildirim almak ister misiniz?</p>
        </div>
        <button onclick="requestNotificationPermission()">İzin Ver</button>
    </div>

    <!-- Status Card -->
    <div class="status-card">
        <div class="status-icon" id="status-icon">
            <i class="fas fa-clock"></i>
        </div>

        <h1 class="status-title" id="status-title">Talebiniz Alındı</h1>
        <p class="status-message" id="status-message">
            Talebiniz başarıyla oluşturuldu. Yakındaki sürücüler bilgilendirildi.
        </p>

        <!-- Info Grid -->
        <div class="info-grid">
            <div class="info-box">
                <div class="info-label">Lokasyon</div>
                <div class="info-value" id="location-name">-</div>
            </div>
            <div class="info-box">
                <div class="info-label">Oda No</div>
                <div class="info-value" id="room-number">-</div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="timeline">
            <div class="timeline-step completed" id="step-requested">
                <div class="timeline-dot">
                    <i class="fas fa-check"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-label">Talep Oluşturuldu</div>
                    <div class="timeline-time" id="time-requested">-</div>
                </div>
            </div>

            <div class="timeline-step" id="step-accepted">
                <div class="timeline-dot">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-label">İşleme Alındı</div>
                    <div class="timeline-time" id="time-accepted">Bekleniyor...</div>
                </div>
            </div>

            <div class="timeline-step" id="step-onway">
                <div class="timeline-dot">
                    <i class="fas fa-shuttle-van"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-label">Shuttle Yolda</div>
                    <div class="timeline-time" id="time-onway">-</div>
                </div>
            </div>

            <div class="timeline-step" id="step-arrived">
                <div class="timeline-dot">
                    <i class="fas fa-flag-checkered"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-label">Geldi</div>
                    <div class="timeline-time" id="time-arrived">-</div>
                </div>
            </div>
        </div>

        <!-- Driver Info -->
        <div class="driver-info" id="driver-info">
            <div class="driver-details">
                <div class="driver-avatar">
                    <i class="fas fa-shuttle-van"></i>
                </div>
                <div class="driver-text">
                    <h4 id="driver-name">Shuttle</h4>
                    <p>Talebiniz <span id="buggy-code">-</span> plakalı shuttle tarafından işleme alınmıştır. En kısa sürede sizinle olacaktır.</p>
                </div>
            </div>
        </div>

        <!-- Completed Message -->
        <div class="completed-box" id="completed-box">
            <div style="font-size: 48px; color: var(--success-green); margin-bottom: 16px;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 style="font-size: 20px; font-weight: 700; color: var(--success-green); margin-bottom: 8px;">
                Talebiniz Tamamlandı!
            </h3>
            <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 24px;">
                İyi yolculuklar dileriz
            </p>
            <button class="btn-primary" onclick="window.location.href='/guest/call'">
                <i class="fas fa-plus-circle"></i>
                Yeni Talep Oluştur
            </button>
        </div>
    </div>

    <!-- Footer -->
    <div class="status-footer">
        <img src="{{ url_for('static', filename='images/Merit_International.png') }}" 
             alt="Merit International" class="footer-logo">
        <p class="footer-text">MERIT INTERNATIONAL HOTELS & RESORTS © 2025</p>
        
        <div class="optimist-brand">
            <img src="{{ url_for('static', filename='images/opti.png') }}" alt="Optimist">
            <span>Optimist Bilişim & Elektronik</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const requestId = {{ request_id }};
let socket;

// Check notification permission on load
document.addEventListener('DOMContentLoaded', function() {
    loadRequestStatus();
    connectWebSocket();
    checkNotificationPermission();
    setInterval(loadRequestStatus, 10000); // Poll every 10 seconds
});

function checkNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        document.getElementById('notification-banner').classList.add('show');
    }
}

function requestNotificationPermission() {
    if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
            document.getElementById('notification-banner').classList.remove('show');
            if (permission === 'granted') {
                new Notification('Bildirimler Aktif', {
                    body: 'Shuttle geldiğinde bildirim alacaksınız',
                    icon: '/static/icons/Icon-192.png'
                });
            }
        });
    }
}

function loadRequestStatus() {
    fetch(`/api/requests/${requestId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStatus(data.request);
            }
        })
        .catch(error => console.error('Error:', error));
}

function updateStatus(request) {
    // Update info
    document.getElementById('location-name').textContent = request.location_name || '-';
    document.getElementById('room-number').textContent = request.room_number || 'Yok';

    // Update times
    if (request.requested_at) {
        document.getElementById('time-requested').textContent = 
            new Date(request.requested_at).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
    }

    const status = request.status;

    if (status === 'PENDING') {
        updateToPending();
    } else if (status === 'ACCEPTED' || status === 'accepted') {
        updateToAccepted(request);
    } else if (status === 'COMPLETED' || status === 'completed') {
        updateToCompleted(request);
    }
}

function updateToPending() {
    document.getElementById('status-title').textContent = 'Sürücü Aranıyor...';
    document.getElementById('status-message').textContent = 
        'Talebiniz yakındaki sürücülere iletildi. En kısa sürede yanıtlanacaktır.';
}

function updateToAccepted(request) {
    // Mark steps as completed
    document.getElementById('step-accepted').classList.add('completed');
    document.getElementById('step-onway').classList.add('completed');

    if (request.accepted_at) {
        document.getElementById('time-accepted').textContent = 
            new Date(request.accepted_at).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
        document.getElementById('time-onway').textContent = 'Şimdi';
    }

    // Update status
    document.getElementById('status-icon').innerHTML = '<i class="fas fa-shuttle-van"></i>';
    document.getElementById('status-title').textContent = 'Shuttle Yolda!';
    document.getElementById('status-message').textContent = 
        'Shuttle yola çıktı. Yakında yanınızda olacak.';

    // Show driver info
    if (request.buggy_code) {
        document.getElementById('buggy-code').textContent = request.buggy_code;
        document.getElementById('driver-info').classList.add('show');
    }
}

function updateToCompleted(request) {
    // Mark all steps as completed
    document.querySelectorAll('.timeline-step').forEach(step => {
        step.classList.add('completed');
    });

    if (request.completed_at) {
        document.getElementById('time-arrived').textContent = 
            new Date(request.completed_at).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
    }

    // Update status
    document.getElementById('status-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
    document.getElementById('status-icon').style.background = 'linear-gradient(135deg, #27AE60, #2ECC71)';
    
    // Show completed message
    document.getElementById('completed-box').classList.add('show');
}

function connectWebSocket() {
    if (typeof io === 'undefined') return;

    socket = io();
    socket.on('connect', function() {
        socket.emit('join_request', {request_id: requestId});
    });

    socket.on('request_accepted', function(data) {
        if (data.request_id === requestId) {
            loadRequestStatus();
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Shuttle Kabul Edildi!', {
                    body: 'Shuttle yola çıktı',
                    icon: '/static/icons/Icon-192.png'
                });
            }
        }
    });

    socket.on('request_completed', function(data) {
        if (data.request_id === requestId) {
            loadRequestStatus();
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Shuttle Geldi!', {
                    body: 'İyi yolculuklar',
                    icon: '/static/icons/Icon-192.png'
                });
            }
        }
    });
}
</script>
{% endblock %}
