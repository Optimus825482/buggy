{% extends "base.html" %}

{% block title %}Talep Durumu{% endblock %}

{% block extra_css %}
<style>
/* ==================== MODERN STATUS PAGE ==================== */
:root {
    --primary-navy: #1A2B4A;
    --royal-gold: #D4AF37;
    --success-green: #27AE60;
    --bg-white: #FFFFFF;
    --bg-light: #F8F9FA;
    --text-dark: #1A2B4A;
    --text-muted: #6B7280;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
}

body {
    background: var(--bg-white);
    min-height: 100vh;
    margin: 0;
    padding: 0;
}

/* Hide base template elements */
.header, .navbar, header, nav, .mobile-menu-toggle, .connection-indicator {
    display: none !important;
}

.main-content {
    padding: 0 !important;
    margin: 0 !important;
}

/* Container */
.status-container {
    max-width: 540px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Status Card */
.status-card {
    background: var(--bg-white);
    border-radius: 20px;
    padding: 32px 24px;
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    text-align: center;
}

.status-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
    background: linear-gradient(135deg, var(--primary-navy), #2A3B5A);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 36px;
}

.status-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 12px;
}

.status-message {
    font-size: 15px;
    color: var(--text-muted);
    line-height: 1.6;
    margin-bottom: 32px;
}

/* Timeline Steps - Renkli ve Dikkat √áekici */
.timeline {
    margin: 32px 0;
}

.timeline-step {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 24px;
    position: relative;
    transition: all 0.3s ease;
}

.timeline-step:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 19px;
    top: 40px;
    width: 3px;
    height: calc(100% + 8px);
    background: linear-gradient(180deg, #E5E7EB 0%, #F3F4F6 100%);
    transition: all 0.5s ease;
}

.timeline-step.completed::after {
    background: linear-gradient(180deg, #10B981 0%, #059669 100%);
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
}

.timeline-step.active::after {
    background: linear-gradient(180deg, #F59E0B 0%, #D97706 100%);
    box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
    animation: pulse-line 2s ease-in-out infinite;
}

.timeline-dot {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #E5E7EB;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    z-index: 1;
    font-size: 20px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Talep Olu≈üturuldu - Ye≈üil */
.timeline-step.completed .timeline-dot {
    background: linear-gradient(135deg, #10B981, #059669);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    animation: bounce-in 0.5s ease;
}

/* ƒ∞≈üleme Alƒ±ndƒ± - Turuncu (Aktif) */
.timeline-step.active .timeline-dot {
    background: linear-gradient(135deg, #F59E0B, #D97706);
    color: white;
    box-shadow: 0 4px 16px rgba(245, 158, 11, 0.5);
    animation: pulse-dot 2s ease-in-out infinite;
}

/* Shuttle Yolda - Mavi (Aktif) */
#step-onway.active .timeline-dot {
    background: linear-gradient(135deg, #3B82F6, #2563EB);
    box-shadow: 0 4px 16px rgba(59, 130, 246, 0.5);
}

/* Geldi - Altƒ±n */
#step-arrived.completed .timeline-dot {
    background: linear-gradient(135deg, #FBBF24, #F59E0B);
    box-shadow: 0 4px 16px rgba(251, 191, 36, 0.5);
}

.timeline-content {
    flex: 1;
    text-align: left;
    padding-top: 8px;
    transition: all 0.3s ease;
}

.timeline-step.active .timeline-content {
    transform: translateX(4px);
}

.timeline-label {
    font-size: 17px;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 4px;
    transition: all 0.3s ease;
}

.timeline-step.completed .timeline-label {
    color: #059669;
}

.timeline-step.active .timeline-label {
    color: #D97706;
    font-size: 18px;
}

.timeline-time {
    font-size: 14px;
    color: var(--text-muted);
    font-weight: 500;
    transition: all 0.3s ease;
}

.timeline-step.active .timeline-time {
    color: #F59E0B;
    font-weight: 600;
}

/* Animasyonlar */
@keyframes pulse-dot {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 4px 16px rgba(245, 158, 11, 0.5);
    }
    50% {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(245, 158, 11, 0.7);
    }
}

@keyframes pulse-line {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

@keyframes bounce-in {
    0% {
        transform: scale(0);
        opacity: 0;
    }
    50% {
        transform: scale(1.2);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Info Grid */
.info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin: 24px 0;
}

.info-box {
    background: var(--bg-light);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
}

.info-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
}

.info-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-dark);
}

/* Driver Info */
.driver-info {
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(228, 191, 71, 0.05));
    border-radius: 16px;
    padding: 20px;
    margin: 24px 0;
    display: none;
}

.driver-info.show {
    display: block;
}

.driver-details {
    display: flex;
    align-items: center;
    gap: 16px;
}

.driver-avatar {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, var(--primary-navy), #2A3B5A);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
}

.driver-text h4 {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-dark);
    margin: 0 0 4px 0;
}

.driver-text p {
    font-size: 14px;
    color: var(--text-muted);
    margin: 0;
}

/* Completed Message */
.completed-box {
    background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(46, 204, 113, 0.05));
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    margin: 24px 0;
    display: none;
}

.completed-box.show {
    display: block;
}

/* Notification Banner */
.notification-banner {
    background: linear-gradient(135deg, var(--primary-navy), #2A3B5A);
    color: white;
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    display: none;
}

.notification-banner.show {
    display: flex;
    align-items: center;
    gap: 12px;
}

.notification-banner button {
    background: var(--royal-gold);
    color: var(--primary-navy);
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}

.notification-banner button:hover {
    background: #E4BF47;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

.notification-banner button:active {
    transform: translateY(0);
}

/* Toast Animations */
@keyframes slideInRight {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}

/* Footer */
.status-footer {
    margin-top: auto;
    padding: 24px 0;
    text-align: center;
}

.footer-logo {
    height: 40px;
    margin-bottom: 12px;
}

.footer-text {
    font-size: 12px;
    color: var(--text-muted);
    margin: 8px 0;
}

.optimist-brand {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #E5E7EB;
}

.optimist-brand img {
    height: 20px;
    opacity: 0.6;
}

.optimist-brand span {
    font-size: 11px;
    color: var(--text-muted);
}

/* Button */
.btn-primary {
    background: linear-gradient(135deg, var(--primary-navy), #2A3B5A);
    color: white;
    border: none;
    padding: 14px 24px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 15px;
    width: 100%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary:hover {
    opacity: 0.9;
}
</style>
{% endblock %}

{% block content %}
<div class="status-container">
    <!-- Notification Permission Banner -->
    <div id="notification-banner" class="notification-banner">
        <i class="fas fa-bell"></i>
        <div style="flex: 1;">
            <strong data-i18n="notif.permission_denied">Bildirimler Kapalƒ±</strong>
            <p style="margin: 0; font-size: 13px; opacity: 0.9;" data-i18n="notif.permission_denied_msg">Shuttle durumu hakkƒ±nda bildirim almak i√ßin izin verin.</p>
        </div>
        <button onclick="requestNotificationPermission()" data-i18n="btn.enable_notifications">ƒ∞zin Ver</button>
    </div>

    <!-- Status Card -->
    <div class="status-card">
        <div class="status-icon" id="status-icon">
            <i class="fas fa-clock"></i>
        </div>

        <h1 class="status-title" id="status-title" data-i18n="request.created">Talebiniz Alƒ±ndƒ±</h1>
        <p class="status-message" id="status-message" data-i18n="request.created_msg">
            Talebiniz ba≈üarƒ±yla olu≈üturuldu. 
        </p>



        <!-- Timeline -->
        <div class="timeline" id="timeline-container">
            <div class="timeline-step completed" id="step-requested">
                <div class="timeline-dot">
                    <i class="fas fa-check"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-label" data-i18n="label.created">Talep Olu≈üturuldu</div>
                    <div class="timeline-time" id="time-requested">-</div>
                </div>
            </div>

            <div class="timeline-step" id="step-accepted">
                <div class="timeline-dot">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-label" data-i18n="label.processing">ƒ∞≈üleme Alƒ±ndƒ±</div>
                    <div class="timeline-time" id="time-accepted" data-i18n="label.waiting">Bekleniyor...</div>
                </div>
            </div>

            <div class="timeline-step" id="step-completed">
                <div class="timeline-dot">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-label" data-i18n="label.completed">Tamamlandƒ±</div>
                    <div class="timeline-time" id="time-completed">-</div>
                </div>
            </div>
        </div>

        <!-- Driver Info -->
        <div class="driver-info" id="driver-info">
            <div class="driver-details">
                <div class="driver-avatar">
                    <i class="fas fa-shuttle-van"></i>
                </div>
                <div class="driver-text">
                    <h4 id="driver-name">Shuttle</h4>
                    <p>Talebiniz <span id="buggy-code">-</span> plakalƒ± shuttle tarafƒ±ndan i≈üleme alƒ±nmƒ±≈ütƒ±r. En kƒ±sa s√ºrede sizinle olacaktƒ±r.</p>
                </div>
            </div>
        </div>

        <!-- Completed Message -->
        <div class="completed-box" id="completed-box">
            <div style="font-size: 48px; color: var(--success-green); margin-bottom: 16px;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 style="font-size: 20px; font-weight: 700; color: var(--success-green); margin-bottom: 8px;">
                ‚úÖ Tamamlandƒ±!
            </h3>
            <p style="font-size: 16px; color: #065f46; margin-bottom: 16px; font-weight: 600;">
                Shuttle Call sistemini kullandƒ±ƒüƒ±nƒ±z i√ßin<br>
                te≈üekk√ºr ederiz! üôè
            </p>
            
            <!-- Service Provider Info -->
            <div style="
                margin-top: 24px;
                padding: 16px;
                background: #f9fafb;
                border-radius: 12px;
                font-size: 11px;
                color: #6b7280;
                line-height: 1.6;
            ">
                Bu hizmet <strong>Optimist Bili≈üim & Elektronik</strong> tarafƒ±ndan<br>
                <strong>MERIT INTERNATIONAL HOTELS</strong> g√ºvencesi ve kalitesiyle verilmektedir.
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="status-footer">
        <img src="{{ url_for('static', filename='images/Merit_International.png') }}" 
             alt="Merit International" class="footer-logo">
        <p class="footer-text">MERIT INTERNATIONAL HOTELS & RESORTS ¬© 2025</p>
        
        <div class="optimist-brand">
            <img src="{{ url_for('static', filename='images/opti.png') }}" alt="Optimist">
            <span>Optimist Bili≈üim & Elektronik</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Multi-Language Support -->
<script src="{{ url_for('static', filename='js/i18n-guest.js') }}"></script>

<!-- Firebase SDK for FCM -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js"></script>

<!-- iOS Notification Handler -->
<script src="{{ url_for('static', filename='js/ios-notification-handler.js') }}"></script>

<!-- Guest Notification Manager -->
<script src="{{ url_for('static', filename='js/guest-notifications.js') }}"></script>

<script>
const requestId = {{ request_id }};
let socket;

// Initialize Guest Notification Manager
let guestNotificationManager;

// Check notification permission on load
document.addEventListener('DOMContentLoaded', async function() {
    loadRequestStatus();
    connectWebSocket();
    
    // Guest Notification Manager'ƒ± ba≈ülat
    try {
        guestNotificationManager = new GuestNotificationManager();
        const initialized = await guestNotificationManager.init();
        
        if (initialized && Notification.permission === 'granted') {
            // Bildirim izni varsa, token'ƒ± kaydet
            await guestNotificationManager.requestPermissionAndGetToken(requestId);
        }
    } catch (error) {
        console.error('‚ùå [FCM] Init error:', error);
    }
    
    checkNotificationPermission();
    setInterval(loadRequestStatus, 10000); // Poll every 10 seconds
});

function checkNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        document.getElementById('notification-banner').classList.add('show');
    }
}

async function requestNotificationPermission() {
    try {
        const banner = document.getElementById('notification-banner');
        
        if (!('Notification' in window)) {
            console.warn('Notifications not supported');
            return;
        }
        
        // iOS kontrol√º
        if (window.iosNotificationHandler && window.iosNotificationHandler.isIOSDevice()) {
            const permission = await window.iosNotificationHandler.requestPermission();
            if (permission === 'granted') {
                banner.classList.remove('show');
                showSuccessToast('Bildirimler aktif edildi! üîî');
            }
        } else {
            // Normal tarayƒ±cƒ±lar
            const permission = await Notification.requestPermission();
            banner.classList.remove('show');
            
            if (permission === 'granted') {
                showSuccessToast('Bildirimler aktif edildi! üîî');
                
                // Guest notification manager varsa token al
                if (guestNotificationManager && requestId) {
                    await guestNotificationManager.requestPermissionAndGetToken(requestId);
                }
                
                new Notification('Bildirimler Aktif', {
                    body: 'Shuttle geldiƒüinde bildirim alacaksƒ±nƒ±z',
                    icon: '/static/icons/Icon-192.png'
                });
            }
        }
    } catch (error) {
        console.error('Notification permission error:', error);
    }
}

function showSuccessToast(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        z-index: 10002;
        animation: slideInRight 0.3s ease;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
    `;
    toast.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}


function loadRequestStatus() {
    fetch(`/api/requests/${requestId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStatus(data.request);
            }
        })
        .catch(error => console.error('Error:', error));
}

function updateStatus(request) {
    // Update info
    document.getElementById('location-name').textContent = request.location_name || '-';
    document.getElementById('room-number').textContent = request.room_number || 'Yok';

    // Update times
    if (request.requested_at) {
        document.getElementById('time-requested').textContent = 
            new Date(request.requested_at).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
    }

    const status = request.status;

    if (status === 'PENDING') {
        updateToPending();
    } else if (status === 'ACCEPTED' || status === 'accepted') {
        updateToAccepted(request);
    } else if (status === 'COMPLETED' || status === 'completed') {
        updateToCompleted(request);
    }
}

function updateToPending() {
    // Talep olu≈üturuldu completed, i≈üleme alƒ±ndƒ± active
    const stepRequested = document.getElementById('step-requested');
    const stepAccepted = document.getElementById('step-accepted');
    const statusTitle = document.getElementById('status-title');
    const statusMessage = document.getElementById('status-message');
    
    if (stepRequested) stepRequested.classList.add('completed');
    if (stepAccepted) {
        stepAccepted.classList.add('active');
        stepAccepted.classList.remove('completed');
    }
    
    if (statusTitle) statusTitle.textContent = 'S√ºr√ºc√º Aranƒ±yor...';
    if (statusMessage) {
        statusMessage.textContent = 'Talebiniz yakƒ±ndaki s√ºr√ºc√ºlere iletildi. En kƒ±sa s√ºrede yanƒ±tlanacaktƒ±r.';
    }
}

function updateToAccepted(request) {
    // Talep olu≈üturuldu completed, i≈üleme alƒ±ndƒ± active
    const stepRequested = document.getElementById('step-requested');
    const stepAccepted = document.getElementById('step-accepted');
    const stepCompleted = document.getElementById('step-completed');
    
    if (stepRequested) stepRequested.classList.add('completed');
    if (stepAccepted) {
        stepAccepted.classList.add('active');
        stepAccepted.classList.remove('completed');
    }
    if (stepCompleted) stepCompleted.classList.remove('completed');

    if (request.accepted_at) {
        const timeAccepted = document.getElementById('time-accepted');
        if (timeAccepted) {
            timeAccepted.textContent = new Date(request.accepted_at).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
        }
    }

    // Update status
    const statusIcon = document.getElementById('status-icon');
    const statusTitle = document.getElementById('status-title');
    const statusMessage = document.getElementById('status-message');
    
    if (statusIcon) statusIcon.innerHTML = '<i class="fas fa-shuttle-van"></i>';
    if (statusTitle) statusTitle.textContent = 'Shuttle Yolda!';
    if (statusMessage) statusMessage.textContent = 'Shuttle yola √ßƒ±ktƒ±. Yakƒ±nda yanƒ±nƒ±zda olacak.';

    // Show driver info
    if (request.buggy_code) {
        const buggyCode = document.getElementById('buggy-code');
        const driverInfo = document.getElementById('driver-info');
        if (buggyCode) buggyCode.textContent = request.buggy_code;
        if (driverInfo) driverInfo.classList.add('show');
    }
}

function updateToCompleted(request) {
    // Hide timeline when completed
    const timeline = document.getElementById('timeline-container');
    if (timeline) {
        timeline.style.display = 'none';
    }

    // Update status
    document.getElementById('status-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
    document.getElementById('status-icon').style.background = 'linear-gradient(135deg, #27AE60, #2ECC71)';
    
    // Show completed message
    document.getElementById('completed-box').classList.add('show');
}

function connectWebSocket() {
    if (typeof io === 'undefined') return;

    socket = io();
    socket.on('connect', function() {
        socket.emit('join_request', {request_id: requestId});
    });

    socket.on('request_accepted', function(data) {
        if (data.request_id === requestId) {
            loadRequestStatus();
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Shuttle Kabul Edildi!', {
                    body: 'Shuttle yola √ßƒ±ktƒ±',
                    icon: '/static/icons/Icon-192.png'
                });
            }
        }
    });

    socket.on('request_completed', function(data) {
        if (data.request_id === requestId) {
            loadRequestStatus();
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Shuttle Geldi!', {
                    body: 'ƒ∞yi yolculuklar',
                    icon: '/static/icons/Icon-192.png'
                });
            }
        }
    });
}
</script>
{% endblock %}
