{% extends "base.html" %}

{% block title %}Talep Durumu{% endblock %}

{% block extra_css %}
<style>
body {
  background: linear-gradient(180deg, #5BC0C3 0%, #4AAFB2 100%);
  min-height: 100vh;
  margin: 0;
  padding: 0;
}

/* Hide all headers and navigation (keep footer visible) */
.header, 
.navbar,
header,
nav,
.mobile-menu-toggle,
.connection-indicator {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
  height: 0 !important;
  overflow: hidden !important;
}

/* Main content full width */
.main-content {
  padding: 0 !important;
  margin: 0 !important;
}

.guest-container {
  padding: 20px;
  max-width: 540px;
  margin: 0 auto;
}
</style>
{% endblock %}

{% block content %}
<div class="guest-container">
    <!-- Status Card -->
    <div class="request-status-card">
        <div class="status-icon-wrapper">
            <div class="status-icon" id="status-icon">
                <i class="fas fa-clock"></i>
            </div>
        </div>

        <h2 class="status-title" id="status-title">Talep Alındı</h2>
        <p class="status-message" id="status-message">
            Talebiniz başarıyla oluşturuldu. Yakındaki sürücüler bilgilendirildi.
        </p>

        <!-- Request Details -->
        <div class="status-timeline">
            <div class="timeline-step completed" id="step-requested">
                <div class="timeline-dot">
                    <i class="fas fa-check"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-label">Talep Oluşturuldu</div>
                    <div class="timeline-time" id="time-requested">-</div>
                </div>
            </div>

            <div class="timeline-step" id="step-accepted">
                <div class="timeline-dot">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-label">Sürücü Kabul Etti</div>
                    <div class="timeline-time" id="time-accepted">Bekleniyor...</div>
                </div>
            </div>

            <div class="timeline-step" id="step-arriving">
                <div class="timeline-dot">
                    <i class="fas fa-truck-pickup"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-label">Yolda</div>
                    <div class="timeline-time" id="time-arriving">-</div>
                </div>
            </div>

            <div class="timeline-step" id="step-arrived">
                <div class="timeline-dot">
                    <i class="fas fa-flag-checkered"></i>
                </div>
                <div class="timeline-content">
                    <div class="timeline-label">Geldi</div>
                    <div class="timeline-time" id="time-arrived">-</div>
                </div>
            </div>
        </div>

        <!-- Location & Room Info -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
            <div style="background: #F9FAFB; border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
                    Lokasyon
                </div>
                <div style="font-size: 16px; font-weight: 700; color: #111827;" id="location-name">
                    -
                </div>
            </div>
            <div style="background: #F9FAFB; border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
                    Oda No
                </div>
                <div style="font-size: 16px; font-weight: 700; color: #111827;" id="room-number-display">
                    -
                </div>
            </div>
        </div>

        <!-- Driver Info (shown when accepted) -->
        <div id="driver-info" style="display: none; background: linear-gradient(135deg, rgba(27, 165, 168, 0.1), rgba(91, 192, 195, 0.05)); border-radius: 16px; padding: 20px; margin-bottom: 24px;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #1BA5A8, #5BC0C3); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; flex-shrink: 0;">
                    <i class="fas fa-user-tie"></i>
                </div>
              
            </div>
        </div>

        <!-- Actions -->
        <div id="action-buttons" style="display: none;">
            <!-- İptal butonu kaldırıldı - Misafirler artık talep iptal edemez -->
        </div>

        <!-- Completed Message -->
        <div id="completed-message" style="display: none;">
            <div style="background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(46, 204, 113, 0.05)); border-radius: 16px; padding: 24px; text-align: center; margin-bottom: 16px;">
                <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #27AE60, #2ECC71); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; margin: 0 auto 16px;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 style="font-size: 20px; font-weight: 700; color: #27AE60; margin-bottom: 8px;">
                    Talebiniz Tamamlandı!
                </h3>
                <p style="font-size: 14px; color: #6B7280;">
                    İyi yolculuklar dileriz
                </p>
            </div>
            <button onclick="window.location.href='/guest/call'" class="btn-primary btn-block" style="height: 50px; border-radius: 14px; font-weight: 700;">
                <i class="fas fa-plus-circle"></i>
                Yeni Talep Oluştur
            </button>
        </div>
    </div>

    <!-- Help Section -->
    <div class="glass-card" style="padding: 20px; margin-top: 24px; text-align: center;">
        <h4 style="font-size: 14px; font-weight: 700; color: #111827; margin-bottom: 8px;">
            Yardıma mı ihtiyacınız var?
        </h4>
        <p style="font-size: 13px; color: #6B7280; margin-bottom: 16px;">
            Herhangi bir sorun yaşıyorsanız resepsiyon ile iletişime geçebilirsiniz
        </p>
        <div style="display: flex; gap: 12px; justify-content: center;">
            <a href="tel:+90" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-phone"></i> Ara
            </a>
            <a href="#" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-envelope"></i> Mesaj
            </a>
        </div>
    </div>
</div>

<!-- Footer Section -->
<footer style="background: #1A2B4A; border-top: 2px solid #D4AF37; padding: 2rem 0; text-align: center; margin-top: 2rem;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
        <img src="{{ url_for('static', filename='images/Merit_International.png') }}" 
             alt="Merit International Hotels & Resorts" 
             style="height: 50px; width: auto; object-fit: contain;">
        <p style="font-size: 14px; font-weight: 600; color: #FFFFFF; letter-spacing: 0.5px; margin: 0;">
            MERIT INTERNATIONAL HOTELS & RESORTS © 2025 COPYRIGHT
        </p>
        
        <!-- Optimist Branding -->
        <div class="optimist-branding" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(212, 175, 55, 0.2); width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem; opacity: 0.85;">
                <img src="{{ url_for('static', filename='images/opti.png') }}" 
                     alt="Optimist Bilişim & Elektronik" 
                     style="height: 26px; width: auto; object-fit: contain; filter: brightness(0) invert(1) opacity(0.9);">
                <div style="text-align: left; line-height: 1.3;">
                    <p style="margin: 0; font-size: 0.7rem; color: #D8D8D8; font-weight: 500;">Sistem Geliştirme & Teknik Destek</p>
                    <p style="margin: 0; font-size: 0.65rem; color: #B8B8B8; font-weight: 400;">Optimist Bilişim & Elektronik</p>
                </div>
            </div>
        </div>
    </div>
</footer>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script>
const requestId = {{ request_id }};
let socket;
let pollingInterval;

document.addEventListener('DOMContentLoaded', function() {
    // Force remove header and footer
    const elementsToRemove = [
        '.header',
        'header',
        '.footer', 
        'footer',
        '.navbar',
        'nav',
        '.mobile-menu-toggle',
        '.connection-indicator'
    ];
    
    elementsToRemove.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
            if (el) {
                el.remove();
            }
        });
    });
    
    // Remove padding from main content
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
        mainContent.style.padding = '0';
        mainContent.style.margin = '0';
    }
    
    loadRequestStatus();
    connectWebSocket();
    startPolling();
});

function loadRequestStatus() {
    fetch(`/api/requests/${requestId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStatus(data.request);
            }
        })
        .catch(error => console.error('Error loading request:', error));
}

function updateStatus(request) {
    // Update location and room
    document.getElementById('location-name').textContent = request.location_name || '-';
    document.getElementById('room-number-display').textContent = request.room_number || 'Belirtilmedi';

    // Update timeline
    if (request.requested_at) {
        document.getElementById('time-requested').textContent = new Date(request.requested_at).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
    }

    // Update status based on request state
    const status = request.status;

    if (status === 'PENDING') {
        updateToPending();
    } else if (status === 'accepted') {
        updateToAccepted(request);
    } else if (status === 'completed') {
        updateToCompleted(request);
    } else if (status === 'cancelled') {
        updateToCancelled();
    }
}

function updateToPending() {
    document.getElementById('status-icon').innerHTML = '<i class="fas fa-clock"></i>';
    document.getElementById('status-title').textContent = 'Sürücü Aranıyor...';
    document.getElementById('status-message').textContent = 'Talebiniz yakındaki sürücülere iletildi. 1 saat içinde yanıtlanmazsa otomatik olarak işaretlenecektir.';
}

function updateToAccepted(request) {
    // Mark accepted step as completed
    const acceptedStep = document.getElementById('step-accepted');
    acceptedStep.classList.add('completed');

    if (request.accepted_at) {
        document.getElementById('time-accepted').textContent = new Date(request.accepted_at).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
    }

    // Update icon and message
    document.getElementById('status-icon').innerHTML = '<i class="fas fa-truck-pickup"></i>';
    document.getElementById('status-title').textContent = 'Shuttle Yolda!';
    document.getElementById('status-message').textContent = 'Sürücünüz yola çıktı. Yakında yanınızda olacak.';

    // Show driver info
    if (request.buggy_code) {
        document.getElementById('driver-name').textContent = request.buggy_code;
        document.getElementById('driver-info').style.display = 'block';
    }

    // Mark arriving step
    const arrivingStep = document.getElementById('step-arriving');
    arrivingStep.classList.add('completed');
    document.getElementById('time-arriving').textContent = 'Şimdi';
}

function updateToCompleted(request) {
    // Mark all steps as completed
    document.querySelectorAll('.timeline-step').forEach(step => {
        step.classList.add('completed');
    });

    if (request.completed_at) {
        document.getElementById('time-arrived').textContent = new Date(request.completed_at).toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
    }

    // Update icon and message
    document.getElementById('status-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
    document.getElementById('status-icon').style.background = 'linear-gradient(135deg, #27AE60, #2ECC71)';

    // Hide action buttons, show completed message
    document.getElementById('action-buttons').style.display = 'none';
    document.getElementById('completed-message').style.display = 'block';
}

function updateToCancelled() {
    document.getElementById('status-icon').innerHTML = '<i class="fas fa-times-circle"></i>';
    document.getElementById('status-icon').style.background = 'linear-gradient(135deg, #E74C3C, #C0392B)';
    document.getElementById('status-title').textContent = 'Talep İptal Edildi';
    document.getElementById('status-message').textContent = 'Talebiniz iptal edildi.';

    document.getElementById('action-buttons').innerHTML = `
        <button onclick="window.location.href='/guest/call'" class="btn-primary btn-block" style="height: 50px; border-radius: 14px; font-weight: 700;">
            <i class="fas fa-plus-circle"></i>
            Yeni Talep Oluştur
        </button>
    `;
}

function connectWebSocket() {
    if (typeof io === 'undefined') return;

    socket = io();

    socket.on('connect', function() {
        console.log('WebSocket connected');
        socket.emit('join_request', {request_id: requestId});
    });

    socket.on('request_accepted', function(data) {
        if (data.request_id === requestId) {
            loadRequestStatus();
            Utils.showToast('Sürücü kabul etti!', 'success');
        }
    });

    socket.on('request_completed', function(data) {
        if (data.request_id === requestId) {
            loadRequestStatus();
            Utils.showToast('Talep tamamlandı!', 'success');
        }
    });

    socket.on('request_cancelled', function(data) {
        if (data.request_id === requestId) {
            loadRequestStatus();
        }
    });
}

function startPolling() {
    // Fallback: poll every 10 seconds if WebSocket fails
    pollingInterval = setInterval(loadRequestStatus, 10000);
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
    if (socket) {
        socket.disconnect();
    }
});
</script>
{% endblock %}
