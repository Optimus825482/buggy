{% extends "base.html" %}

{% block title %}Shuttle'lar{% endblock %}

{% block header_nav %}
<nav class="nav">
    <a href="{{ url_for('admin.dashboard') }}" class="nav-link">
        <i class="fas fa-home"></i> Dashboard
    </a>
    <a href="{{ url_for('admin.locations') }}" class="nav-link">
        <i class="fas fa-map-marker-alt"></i> Lokasyonlar
    </a>
    <a href="{{ url_for('admin.buggies') }}" class="nav-link active">
        <i class="fas fa-truck-pickup"></i> Shuttle'lar
    </a>
    <a href="{{ url_for('admin.reports') }}" class="nav-link">
        <i class="fas fa-chart-bar"></i> Raporlar
    </a>
    <a href="#" onclick="logout()" class="nav-link">
        <i class="fas fa-sign-out-alt"></i> √áƒ±kƒ±≈ü
    </a>
</nav>
{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 0;" data-hotel-id="{{ session.get('hotel_id', 1) }}">
    <div class="d-flex justify-between align-center" style="margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
        <h1 style="margin: 0;"><i class="fas fa-truck-pickup text-primary"></i> Shuttle Y√∂netimi</h1>
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <button class="btn btn-info" onclick="showDriversManagement()">
                <i class="fas fa-users"></i> <span class="btn-text">S√ºr√ºc√º Y√∂netimi</span>
            </button>
            <button class="btn btn-primary" onclick="showAddBuggy()">
                <i class="fas fa-plus"></i> <span class="btn-text">Yeni Shuttle</span>
            </button>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Icon</th>
                            <th>Shuttle Kodu</th>
                            <th>Plaka</th>
                            <th>S√ºr√ºc√º</th>
                            <th>Lokasyon</th>
                            <th>Durum</th>
                            <th>ƒ∞≈ülemler</th>
                        </tr>
                    </thead>
                    <tbody id="buggies-table">
                        <tr>
                            <td colspan="7" class="text-center">Y√ºkleniyor...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Admin sayfasƒ± olduƒüunu i≈üaretle
    document.body.dataset.page = 'admin';
    
    let buggies = [];
    let drivers = [];

    document.addEventListener( 'DOMContentLoaded', () => {
        loadData();
        initializeWebSocket();
    } );

    async function loadData() {
        await Promise.all( [loadBuggies(), loadDrivers()] );
    }

    async function loadBuggies() {
        try {
            const response = await fetch( '/api/buggies' );
            const data = await response.json();

            if ( response.ok && data.success ) {
                buggies = data.buggies;
                renderBuggies();
            }
        } catch ( error ) {
            console.error( 'Error loading shuttles:', error );
            showToast( 'Shuttle\'lar y√ºklenemedi', 'danger' );
        }
    }

    async function loadDrivers() {
        try {
            const response = await fetch( '/api/drivers' );
            const data = await response.json();

            if ( response.ok && data.success ) {
                drivers = data.drivers;
            }
        } catch ( error ) {
            console.error( 'Error loading drivers:', error );
        }
    }

    function renderBuggies() {
        const tbody = document.getElementById( 'buggies-table' );

        if ( buggies.length === 0 ) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Hen√ºz shuttle eklenmemi≈ü</td></tr>';
            return;
        }

        const statusColors = {
            'available': 'success',
            'busy': 'warning',
            'offline': 'secondary'
        };

        const statusLabels = {
            'available': 'M√ºsait',
            'busy': 'Me≈ügul',
            'offline': '√áevrimdƒ±≈üƒ±'
        };

        tbody.innerHTML = buggies.map( buggy => `
            <tr>
                <td style="font-size: 1.5rem; text-align: center;">${buggy.icon || 'üöó'}</td>
                <td><strong>${buggy.code}</strong></td>
                <td>${buggy.license_plate || '-'}</td>
                <td>
                    ${buggy.driver_name ? 
                        `<span>${buggy.driver_name}</span>
                         <span class="badge badge-${buggy.status === 'available' || buggy.status === 'busy' ? 'success' : 'secondary'}" style="margin-left: 0.5rem;">
                            ${buggy.status === 'available' || buggy.status === 'busy' ? 'Aktif' : '√áevrimdƒ±≈üƒ±'}
                         </span>` : 
                        '<span class="text-muted">Atanmadƒ±</span>'
                    }
                </td>
                <td>
                    ${buggy.current_location ? 
                        `<span class="badge badge-info">
                            <i class="fas fa-map-marker-alt"></i> ${buggy.current_location.name}
                        </span>` : 
                        '<span class="text-muted">Bilinmiyor</span>'
                    }
                </td>
                <td>
                    <span class="badge badge-${statusColors[buggy.status] || 'secondary'}">
                        ${statusLabels[buggy.status] || buggy.status}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editBuggy(${buggy.id})" title="D√ºzenle">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-success" onclick="showAssignDriverModal(${buggy.id})" title="S√ºr√ºc√º Ekle">
                        <i class="fas fa-user-plus"></i>
                    </button>
                    ${buggy.driver_id ? 
                        `<button class="btn btn-sm btn-warning" onclick="showTransferDriverModal(${buggy.id})" title="Transfer Et">
                            <i class="fas fa-exchange-alt"></i>
                        </button>` : ''
                    }
                    ${buggy.driver_id && (buggy.status === 'available' || buggy.status === 'busy') ? 
                        `<button class="btn btn-sm btn-danger" onclick="closeDriverSession(${buggy.driver_id})" title="Oturumu Kapat">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>` : ''
                    }
                    <button class="btn btn-sm btn-danger" onclick="deleteBuggy(${buggy.id})" title="Sil">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join( '' );
    }

    async function showAddBuggy() {
        // Create driver options HTML
        let driverOptions = '<option value="">Mevcut S√ºr√ºc√º Se√ß</option>';
        driverOptions += '<option value="null">Atama Yapma</option>';
        driverOptions += '<option value="new">üÜï Yeni S√ºr√ºc√º Olu≈ütur</option>';
        drivers.forEach( d => {
            driverOptions += `<option value="${d.id}">${d.full_name || d.username}</option>`;
        } );

        const modalContent = `
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Shuttle Kodu *</label>
                    <input type="text" id="add-code" placeholder="SHUTTLE-01" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                           required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Icon (Emoji)</label>
                    <input type="text" id="add-icon" maxlength="2"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-2xl text-center" 
                           placeholder="üöó">
                    <p class="text-xs text-gray-500 mt-1">√ñrnek: üöó üöô üöï üèé üöê üöò üöñ</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Plaka</label>
                    <input type="text" id="add-license-plate" placeholder="34ABC123" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">S√ºr√ºc√º</label>
                    <select id="add-driver" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                            onchange="handleDriverSelection(this.value)">
                        ${driverOptions}
                    </select>
                </div>
                <!-- New driver fields (hidden by default) -->
                <div id="new-driver-fields" class="hidden space-y-3 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h4 class="text-sm font-semibold text-blue-900 mb-2">
                        <i class="fas fa-user-plus"></i> Yeni S√ºr√ºc√º Bilgileri
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ad *</label>
                            <input type="text" id="driver-first-name" 
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Soyad *</label>
                            <input type="text" id="driver-last-name" 
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Kullanƒ±cƒ± Adƒ± *</label>
                        <input type="text" id="driver-username" 
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                               placeholder="surucu01">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">≈ûifre *</label>
                        <input type="password" id="driver-password" 
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                               placeholder="Minimum 6 karakter">
                    </div>

                </div>
            </div>
        `;

        const result = await BuggyModal.custom( modalContent, {
            title: 'üöó Yeni Shuttle Ekle',
            confirmText: 'Ekle',
            cancelText: 'ƒ∞ptal',
            size: 'medium'
        } );

        if ( result ) {
            const code = document.getElementById( 'add-code' ).value.trim();
            const icon = document.getElementById( 'add-icon' ).value.trim();
            const licensePlate = document.getElementById( 'add-license-plate' ).value.trim();
            const driverValue = document.getElementById( 'add-driver' ).value;

            if ( !code ) {
                await showError( 'Buggy kodu bo≈ü olamaz!' );
                return;
            }

            let driver_id = null;

            // Check if creating new driver
            if ( driverValue === 'new' ) {
                const firstName = document.getElementById( 'driver-first-name' ).value.trim();
                const lastName = document.getElementById( 'driver-last-name' ).value.trim();
                const username = document.getElementById( 'driver-username' ).value.trim();
                const password = document.getElementById( 'driver-password' ).value;

                if ( !firstName || !lastName || !username || !password ) {
                    await showError( 'Yeni s√ºr√ºc√º i√ßin t√ºm zorunlu alanlarƒ± doldurun!' );
                    return;
                }

                if ( password.length < 6 ) {
                    await showError( '≈ûifre en az 6 karakter olmalƒ±dƒ±r!' );
                    return;
                }

                // Create new driver first
                try {
                    console.log('üîÑ Creating new driver:', { username, firstName, lastName });
                    
                    const driverResponse = await fetch( '/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify( {
                            username,
                            password,
                            first_name: firstName,
                            last_name: lastName,
                            role: 'driver'
                        } )
                    } );

                    const driverResult = await driverResponse.json();
                    console.log('üì• Driver creation response:', driverResult);

                    if ( driverResponse.ok && driverResult.success ) {
                        driver_id = driverResult.user.id;
                        console.log('‚úÖ Driver created successfully with ID:', driver_id);
                        await showSuccess( `S√ºr√ºc√º "${firstName} ${lastName}" ba≈üarƒ±yla olu≈üturuldu!` );
                        // Reload drivers list
                        await loadDrivers();
                    } else {
                        console.error('‚ùå Driver creation failed:', driverResult.error);
                        await showError( 'S√ºr√ºc√º olu≈üturulamadƒ±: ' + ( driverResult.error || 'Bilinmeyen hata' ) );
                        return;
                    }
                } catch ( error ) {
                    console.error('‚ùå Driver creation error:', error);
                    await showError( 'S√ºr√ºc√º olu≈üturulurken hata olu≈ütu: ' + error.message );
                    return;
                }
            } else if ( driverValue !== 'null' && driverValue !== '' ) {
                driver_id = parseInt( driverValue );
            }

            // Now create buggy
            console.log('üöó Creating buggy with driver_id:', driver_id);
            await addBuggy( { code, icon, license_plate: licensePlate, driver_id } );
        }
    }

    // Helper function to show/hide new driver fields
    window.handleDriverSelection = function ( value ) {
        const newDriverFields = document.getElementById( 'new-driver-fields' );
        if ( newDriverFields ) {
            if ( value === 'new' ) {
                newDriverFields.classList.remove( 'hidden' );
            } else {
                newDriverFields.classList.add( 'hidden' );
            }
        }
    };

    async function addBuggy( data ) {
        try {
            console.log('üîÑ Sending buggy data to API:', data);
            
            const response = await fetch( '/api/buggies', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify( data )
            } );

            const result = await response.json();
            console.log('üì• Buggy creation response:', result);

            if ( response.ok && result.success ) {
                console.log('‚úÖ Buggy created successfully:', result.buggy);
                if (result.driver) {
                    console.log('‚úÖ Driver assigned:', result.driver);
                }
                await showSuccess( result.message || 'Shuttle ba≈üarƒ±yla eklendi!' );
                await loadBuggies();
                await loadDrivers(); // Refresh driver list
            } else {
                console.error('‚ùå Buggy creation failed:', result.error);
                await showError( result.error || 'Shuttle eklenemedi!' );
            }
        } catch ( error ) {
            console.error( '‚ùå Error adding shuttle:', error );
            await showError( 'Shuttle eklenirken bir hata olu≈ütu: ' + error.message );
        }
    }

    async function editBuggy( id ) {
        const buggy = buggies.find( b => b.id === id );
        if ( !buggy ) {
            await showError( 'Shuttle bulunamadƒ±!' );
            return;
        }

        // Create driver options HTML
        let driverOptions = '<option value="">S√ºr√ºc√º Se√ßin</option>';
        driverOptions += '<option value="null">Atama Kaldƒ±r</option>';
        drivers.forEach( d => {
            const selected = buggy.driver_id === d.id ? 'selected' : '';
            driverOptions += `<option value="${d.id}" ${selected}>${d.full_name || d.username}</option>`;
        } );

        const modalContent = `
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Shuttle Kodu *</label>
                    <input type="text" id="edit-code" value="${buggy.code}" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                           required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Icon (Emoji)</label>
                    <input type="text" id="edit-icon" maxlength="2" value="${buggy.icon || ''}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-2xl text-center" 
                           placeholder="üöó">
                    <p class="text-xs text-gray-500 mt-1">√ñrnek: üöó üöô üöï üèé üöê üöò üöñ</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Plaka</label>
                    <input type="text" id="edit-license-plate" value="${buggy.license_plate || ''}" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">S√ºr√ºc√º</label>
                    <select id="edit-driver" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        ${driverOptions}
                    </select>
                </div>
            </div>
        `;

        const result = await BuggyModal.custom( modalContent, {
            title: 'Shuttle D√ºzenle',
            confirmText: 'G√ºncelle',
            cancelText: 'ƒ∞ptal',
            size: 'medium'
        } );

        if ( result ) {
            const code = document.getElementById( 'edit-code' ).value.trim();
            const icon = document.getElementById( 'edit-icon' ).value.trim();
            const licensePlate = document.getElementById( 'edit-license-plate' ).value.trim();
            const driverValue = document.getElementById( 'edit-driver' ).value;
            const driver_id = driverValue === 'null' || driverValue === '' ? null : parseInt( driverValue );

            if ( !code ) {
                await showError( 'Shuttle kodu bo≈ü olamaz!' );
                return;
            }

            try {
                const response = await fetch( `/api/buggies/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify( { code, icon, license_plate: licensePlate, driver_id } )
                } );

                const apiResult = await response.json();

                if ( response.ok && apiResult.success ) {
                    await showSuccess( 'Shuttle ba≈üarƒ±yla g√ºncellendi!' );
                    loadBuggies();
                } else {
                    await showError( apiResult.error || 'Shuttle g√ºncellenemedi!' );
                }
            } catch ( error ) {
                console.error( 'Error updating shuttle:', error );
                await showError( 'Shuttle g√ºncellenirken bir hata olu≈ütu: ' + error.message );
            }
        }
    }

    async function deleteBuggy( id ) {
        const confirmed = await BuggyModal.confirm(
            'Bu shuttle\'ƒ± silmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz.',
            'Shuttle Sil',
            'Evet, Sil',
            'ƒ∞ptal'
        );

        if ( !confirmed ) return;

        try {
            const response = await fetch( `/api/buggies/${id}`, {
                method: 'DELETE'
            } );

            const result = await response.json();

            if ( response.ok && result.success ) {
                await showSuccess( 'Shuttle ba≈üarƒ±yla silindi!' );
                loadBuggies();
            } else {
                await showError( result.error || 'Shuttle silinemedi!' );
            }
        } catch ( error ) {
            console.error( 'Error deleting shuttle:', error );
            await showError( 'Shuttle silinirken bir hata olu≈ütu: ' + error.message );
        }
    }

    function showToast( message, type = 'info' ) {
        const toast = document.createElement( 'div' );
        toast.className = `alert alert-${type}`;
        toast.style.cssText = 'position:fixed;top:20px;right:20px;z-index:10000;min-width:250px;animation:slideIn 0.3s;';
        toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'times-circle' : 'info-circle'}"></i> ${message}`;
        document.body.appendChild( toast );
        setTimeout( () => toast.remove(), 3000 );
    }

    function logout() {
        if ( confirm( '√áƒ±kƒ±≈ü yapmak istediƒüinize emin misiniz?' ) ) {
            window.location.href = '/auth/logout';
        }
    }

    // ==================== WebSocket Real-Time Updates ====================
    let socket = null;

    function initializeWebSocket() {
        if (typeof io === 'undefined') {
            console.warn('Socket.IO not available');
            return;
        }

        // Connect to Socket.IO server
        socket = io({
            transports: ['polling', 'websocket'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5
        });

        socket.on('connect', () => {
            console.log('Socket connected');
            // Join admin room
            const hotelId = parseInt(document.querySelector('.container').dataset.hotelId) || 1;
            socket.emit('join_hotel', {
                hotel_id: hotelId,
                role: 'admin'
            });
        });

        // Listen for driver assigned event
        socket.on('driver_assigned', (data) => {
            console.log('Driver assigned:', data);
            showToast(`${data.driver_name} ${data.buggy_code} shuttle'ƒ±na atandƒ±`, 'success');
            loadBuggies(); // Refresh shuttle list
        });

        // Listen for driver transferred event
        socket.on('driver_transferred', (data) => {
            console.log('Driver transferred:', data);
            const message = `${data.driver_name} ${data.source_buggy_code}'dan ${data.target_buggy_code}'a transfer edildi`;
            showToast(message, 'success');
            loadBuggies(); // Refresh shuttle list
        });

        socket.on('disconnect', () => {
            console.log('Socket disconnected');
        });

        socket.on('error', (error) => {
            console.error('Socket error:', error);
        });
    }

    // ==================== Driver Assignment Functions ====================
    async function showAssignDriverModal(buggyId) {
        const buggy = buggies.find(b => b.id === buggyId);
        if (!buggy) {
            await showError('Shuttle bulunamadƒ±!');
            return;
        }

        // Filter out drivers that are already assigned to other buggies
        const assignedDriverIds = buggies
            .filter(b => b.driver_id && b.id !== buggyId)
            .map(b => b.driver_id);
        
        const availableDrivers = drivers.filter(d => !assignedDriverIds.includes(d.id));

        let driverOptions = '<option value="">S√ºr√ºc√º Se√ßin</option>';
        driverOptions += '<option value="new">üÜï Yeni S√ºr√ºc√º Olu≈ütur</option>';
        availableDrivers.forEach(d => {
            driverOptions += `<option value="${d.id}">${d.full_name || d.username}</option>`;
        });

        const modalContent = `
            <div class="space-y-4">
                <p class="text-center"><strong>Shuttle:</strong> ${buggy.code}</p>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">S√ºr√ºc√º Se√ß *</label>
                    <select id="assign-driver-select" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                            onchange="handleAssignDriverSelection(this.value)"
                            required>
                        ${driverOptions}
                    </select>
                </div>
                <!-- New driver fields (hidden by default) -->
                <div id="assign-new-driver-fields" class="hidden space-y-3 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h4 class="text-sm font-semibold text-blue-900 mb-2">
                        <i class="fas fa-user-plus"></i> Yeni S√ºr√ºc√º Bilgileri
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ad *</label>
                            <input type="text" id="assign-driver-first-name" 
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Soyad *</label>
                            <input type="text" id="assign-driver-last-name" 
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Kullanƒ±cƒ± Adƒ± *</label>
                        <input type="text" id="assign-driver-username" 
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                               placeholder="surucu01">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">≈ûifre *</label>
                        <input type="password" id="assign-driver-password" 
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                               placeholder="Minimum 6 karakter">
                    </div>

                </div>
            </div>
        `;

        const result = await BuggyModal.custom(modalContent, {
            title: 'üë§ S√ºr√ºc√º Ekle',
            confirmText: 'Ekle',
            cancelText: 'ƒ∞ptal',
            size: 'medium'
        });

        if (result) {
            const driverValue = document.getElementById('assign-driver-select').value;
            
            if (!driverValue) {
                await showError('L√ºtfen bir s√ºr√ºc√º se√ßin!');
                return showAssignDriverModal(buggyId); // Show again
            }

            let driverId = null;

            // Check if creating new driver
            if (driverValue === 'new') {
                const firstName = document.getElementById('assign-driver-first-name').value.trim();
                const lastName = document.getElementById('assign-driver-last-name').value.trim();
                const username = document.getElementById('assign-driver-username').value.trim();
                const password = document.getElementById('assign-driver-password').value;

                if (!firstName || !lastName || !username || !password) {
                    await showError('Yeni s√ºr√ºc√º i√ßin t√ºm zorunlu alanlarƒ± doldurun!');
                    return showAssignDriverModal(buggyId);
                }

                if (password.length < 6) {
                    await showError('≈ûifre en az 6 karakter olmalƒ±dƒ±r!');
                    return showAssignDriverModal(buggyId);
                }

                // Create new driver first
                try {
                    const driverResponse = await fetch('/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username,
                            password,
                            first_name: firstName,
                            last_name: lastName,
                            role: 'driver'
                        })
                    });

                    const driverResult = await driverResponse.json();

                    if (driverResponse.ok && driverResult.success) {
                        driverId = driverResult.user.id;
                        await showSuccess(`S√ºr√ºc√º "${firstName} ${lastName}" ba≈üarƒ±yla olu≈üturuldu!`);
                        await loadDrivers(); // Refresh driver list
                    } else {
                        await showError('S√ºr√ºc√º olu≈üturulamadƒ±: ' + (driverResult.error || 'Bilinmeyen hata'));
                        return;
                    }
                } catch (error) {
                    await showError('S√ºr√ºc√º olu≈üturulurken hata olu≈ütu: ' + error.message);
                    return;
                }
            } else {
                driverId = parseInt(driverValue);
            }

            await assignDriverToBuggy(buggyId, driverId);
        }
    }

    // Helper function to show/hide new driver fields in assign modal
    window.handleAssignDriverSelection = function(value) {
        const newDriverFields = document.getElementById('assign-new-driver-fields');
        if (newDriverFields) {
            if (value === 'new') {
                newDriverFields.classList.remove('hidden');
            } else {
                newDriverFields.classList.add('hidden');
            }
        }
    };

    async function assignDriverToBuggy(buggyId, driverId) {
        try {
            const response = await fetch('/api/admin/assign-driver-to-buggy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ buggy_id: buggyId, driver_id: driverId })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                await showSuccess(data.message || 'S√ºr√ºc√º ba≈üarƒ±yla atandƒ±!');
                await loadBuggies();
            } else {
                await showError(data.error || 'S√ºr√ºc√º atanamadƒ±!');
            }
        } catch (error) {
            console.error('Error assigning driver:', error);
            await showError('S√ºr√ºc√º atanƒ±rken bir hata olu≈ütu: ' + error.message);
        }
    }

    // ==================== Driver Transfer Functions ====================
    async function showTransferDriverModal(buggyId) {
        const sourceBuggy = buggies.find(b => b.id === buggyId);
        if (!sourceBuggy) {
            await showError('Shuttle bulunamadƒ±!');
            return;
        }

        if (!sourceBuggy.driver_id) {
            await showError('Bu shuttle\'da s√ºr√ºc√º yok!');
            return;
        }

        // Get available target buggies (exclude source buggy)
        const targetBuggies = buggies.filter(b => b.id !== buggyId);

        if (targetBuggies.length === 0) {
            await showError('Transfer edilebilecek ba≈üka shuttle yok!');
            return;
        }

        let buggyOptions = '<option value="">Hedef Shuttle Se√ßin</option>';
        targetBuggies.forEach(b => {
            const driverInfo = b.driver_name ? ` (S√ºr√ºc√º: ${b.driver_name})` : ' (Bo≈ü)';
            buggyOptions += `<option value="${b.id}">${b.code}${driverInfo}</option>`;
        });

        const modalContent = `
            <div class="space-y-4">
                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <p class="text-sm"><strong>Mevcut S√ºr√ºc√º:</strong> ${sourceBuggy.driver_name}</p>
                    <p class="text-sm"><strong>Mevcut Shuttle:</strong> ${sourceBuggy.code}</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Hedef Shuttle *</label>
                    <select id="transfer-target-buggy" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                            required>
                        ${buggyOptions}
                    </select>
                </div>
                <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                    <p class="text-sm text-yellow-800">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Uyarƒ±:</strong> S√ºr√ºc√ºn√ºn aktif oturumu varsa kapatƒ±lacak ve her iki shuttle √ßevrimdƒ±≈üƒ± olacak.
                    </p>
                </div>
            </div>
        `;

        const result = await BuggyModal.custom(modalContent, {
            title: 'üîÑ S√ºr√ºc√º Transfer Et',
            confirmText: 'Transfer Et',
            cancelText: 'ƒ∞ptal',
            size: 'medium'
        });

        if (result) {
            const targetBuggyId = document.getElementById('transfer-target-buggy').value;
            
            if (!targetBuggyId) {
                await showError('L√ºtfen hedef shuttle se√ßin!');
                return showTransferDriverModal(buggyId); // Show again
            }

            await transferDriver(sourceBuggy.driver_id, buggyId, parseInt(targetBuggyId));
        }
    }

    async function transferDriver(driverId, sourceBuggyId, targetBuggyId) {
        try {
            const response = await fetch('/api/admin/transfer-driver', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    driver_id: driverId,
                    source_buggy_id: sourceBuggyId,
                    target_buggy_id: targetBuggyId
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                await showSuccess(data.message || 'S√ºr√ºc√º ba≈üarƒ±yla transfer edildi!');
                if (data.session_terminated) {
                    await BuggyModal.alert('S√ºr√ºc√ºn√ºn aktif oturumu sonlandƒ±rƒ±ldƒ± ve her iki shuttle √ßevrimdƒ±≈üƒ± yapƒ±ldƒ±.');
                }
                await loadBuggies();
            } else {
                await showError(data.error || 'S√ºr√ºc√º transfer edilemedi!');
            }
        } catch (error) {
            console.error('Error transferring driver:', error);
            await showError('S√ºr√ºc√º transfer edilirken bir hata olu≈ütu: ' + error.message);
        }
    }

    // ==================== Close Driver Session ====================
    async function closeDriverSession(driverId) {
        const confirmed = await BuggyModal.confirm(
            'Bu s√ºr√ºc√ºn√ºn oturumunu kapatmak istediƒüinize emin misiniz? S√ºr√ºc√º √ßƒ±kƒ±≈ü yapmƒ±≈ü gibi olacak ve shuttle √ßevrimdƒ±≈üƒ± olacak.',
            'Oturumu Kapat',
            'Evet, Kapat',
            'ƒ∞ptal'
        );

        if (!confirmed) return;

        try {
            const response = await fetch(`/api/admin/close-driver-session/${driverId}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                await showSuccess(data.message || 'S√ºr√ºc√º oturumu ba≈üarƒ±yla kapatƒ±ldƒ±!');
                await loadBuggies();
            } else {
                await showError(data.error || 'Oturum kapatƒ±lamadƒ±!');
            }
        } catch (error) {
            console.error('Error closing driver session:', error);
            await showError('Oturum kapatƒ±lƒ±rken bir hata olu≈ütu: ' + error.message);
        }
    }

    // ==================== S√ºr√ºc√º Y√∂netimi ====================
    let driversManagementModalOpen = false;

    async function refreshDriversTable() {
        // Verileri yenile
        await Promise.all([loadDrivers(), loadBuggies()]);
        
        // Ana shuttle listesini de yenile
        renderBuggies();
        
        // Tabloyu g√ºncelle
        const tbody = document.getElementById('drivers-management-table');
        if (!tbody) return; // Modal kapalƒ±ysa √ßƒ±k
        
        const driversTableRows = drivers.map(driver => {
            // S√ºr√ºc√ºn√ºn atandƒ±ƒüƒ± shuttle'ƒ± bul
            const assignedBuggy = buggies.find(b => b.driver_id === driver.id);
            const buggyInfo = assignedBuggy ? 
                `<span class="badge badge-info">${assignedBuggy.code}</span>` : 
                '<span class="text-muted">Atanmadƒ±</span>';
            
            return `
                <tr>
                    <td><strong>${driver.full_name || driver.username}</strong></td>
                    <td>${driver.username}</td>
                    <td>${buggyInfo}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editDriver(${driver.id})" title="D√ºzenle">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDriver(${driver.id})" title="Sil">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        tbody.innerHTML = driversTableRows || '<tr><td colspan="4" class="text-center">Hen√ºz s√ºr√ºc√º eklenmemi≈ü</td></tr>';
    }

    async function showDriversManagement() {
        driversManagementModalOpen = true;
        await loadDrivers(); // Refresh driver list
        await loadBuggies(); // Refresh buggy list
        
        const driversTableRows = drivers.map(driver => {
            // S√ºr√ºc√ºn√ºn atandƒ±ƒüƒ± shuttle'ƒ± bul
            const assignedBuggy = buggies.find(b => b.driver_id === driver.id);
            const buggyInfo = assignedBuggy ? 
                `<span class="badge badge-info">${assignedBuggy.code}</span>` : 
                '<span class="text-muted">Atanmadƒ±</span>';
            
            return `
                <tr>
                    <td><strong>${driver.full_name || driver.username}</strong></td>
                    <td>${driver.username}</td>
                    <td>${buggyInfo}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editDriver(${driver.id})" title="D√ºzenle">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDriver(${driver.id})" title="Sil">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        const modalContent = `
            <div class="space-y-4">
                <div class="d-flex justify-between align-center" style="margin-bottom: 1rem;">
                    <h3 style="margin: 0;">Kayƒ±tlƒ± S√ºr√ºc√ºler</h3>
                    <button class="btn btn-sm btn-success" onclick="showAddDriverModal()">
                        <i class="fas fa-user-plus"></i> Yeni S√ºr√ºc√º
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ad Soyad</th>
                                <th>Kullanƒ±cƒ± Adƒ±</th>
                                <th>Atandƒ±ƒüƒ± Shuttle</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody id="drivers-management-table">
                            ${driversTableRows || '<tr><td colspan="4" class="text-center">Hen√ºz s√ºr√ºc√º eklenmemi≈ü</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        await BuggyModal.custom(modalContent, {
            title: 'üë• S√ºr√ºc√º Y√∂netimi',
            confirmText: 'Kapat',
            
            size: 'large',
            onClose: () => {
                driversManagementModalOpen = false;
            }
        });
    }

    async function showAddDriverModal() {
        const modalContent = `
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ad *</label>
                        <input type="text" id="new-driver-first-name" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                               required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Soyad *</label>
                        <input type="text" id="new-driver-last-name" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                               required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kullanƒ±cƒ± Adƒ± *</label>
                    <input type="text" id="new-driver-username" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                           placeholder="surucu01"
                           required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">≈ûifre *</label>
                    <input type="password" id="new-driver-password" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                           placeholder="Minimum 6 karakter"
                           required>
                </div>

            </div>
        `;

        const result = await BuggyModal.custom(modalContent, {
            title: '‚ûï Yeni S√ºr√ºc√º Ekle',
            confirmText: 'Ekle',
            cancelText: 'ƒ∞ptal',
            size: 'medium'
        });

        if (result) {
            const firstName = document.getElementById('new-driver-first-name').value.trim();
            const lastName = document.getElementById('new-driver-last-name').value.trim();
            const username = document.getElementById('new-driver-username').value.trim();
            const password = document.getElementById('new-driver-password').value;

            if (!firstName || !lastName || !username || !password) {
                await showError('T√ºm zorunlu alanlarƒ± doldurun!');
                return showAddDriverModal();
            }

            if (password.length < 6) {
                await showError('≈ûifre en az 6 karakter olmalƒ±dƒ±r!');
                return showAddDriverModal();
            }

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        password,
                        first_name: firstName,
                        last_name: lastName,
                        role: 'driver'
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    await showSuccess(`S√ºr√ºc√º "${firstName} ${lastName}" ba≈üarƒ±yla eklendi!`);
                    await refreshDriversTable(); // Tabloyu yenile
                } else {
                    await showError('S√ºr√ºc√º eklenemedi: ' + (data.error || 'Bilinmeyen hata'));
                }
            } catch (error) {
                await showError('S√ºr√ºc√º eklenirken hata olu≈ütu: ' + error.message);
            }
        }
    }

    async function editDriver(driverId) {
        const driver = drivers.find(d => d.id === driverId);
        if (!driver) {
            await showError('S√ºr√ºc√º bulunamadƒ±!');
            return;
        }

        // Fetch full driver details
        try {
            const response = await fetch(`/api/users/${driverId}`);
            const data = await response.json();
            
            if (!response.ok || !data.success) {
                await showError('S√ºr√ºc√º bilgileri y√ºklenemedi!');
                return;
            }

            const driverDetails = data.user;

            const modalContent = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ad *</label>
                            <input type="text" id="edit-driver-first-name" 
                                   value="${driverDetails.first_name || ''}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                   required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Soyad *</label>
                            <input type="text" id="edit-driver-last-name" 
                                   value="${driverDetails.last_name || ''}"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                   required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kullanƒ±cƒ± Adƒ±</label>
                        <input type="text" id="edit-driver-username" 
                               value="${driverDetails.username}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100"
                               disabled>
                        <p class="text-xs text-gray-500 mt-1">Kullanƒ±cƒ± adƒ± deƒüi≈ütirilemez</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Yeni ≈ûifre</label>
                        <input type="password" id="edit-driver-password" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                               placeholder="Deƒüi≈ütirmek i√ßin yeni ≈üifre girin">
                        <p class="text-xs text-gray-500 mt-1">Bo≈ü bƒ±rakƒ±rsanƒ±z ≈üifre deƒüi≈ümez</p>
                    </div>

                </div>
            `;

            const result = await BuggyModal.custom(modalContent, {
                title: '‚úèÔ∏è S√ºr√ºc√º Bilgilerini D√ºzenle',
                confirmText: 'G√ºncelle',
                cancelText: 'ƒ∞ptal',
                size: 'medium'
            });

            if (result) {
                const firstName = document.getElementById('edit-driver-first-name').value.trim();
                const lastName = document.getElementById('edit-driver-last-name').value.trim();
                const password = document.getElementById('edit-driver-password').value;

                if (!firstName || !lastName) {
                    await showError('Ad ve soyad bo≈ü olamaz!');
                    return editDriver(driverId);
                }

                if (password && password.length < 6) {
                    await showError('≈ûifre en az 6 karakter olmalƒ±dƒ±r!');
                    return editDriver(driverId);
                }

                const updateData = {
                    first_name: firstName,
                    last_name: lastName
                };

                if (password) {
                    updateData.password = password;
                }

                try {
                    const updateResponse = await fetch(`/api/users/${driverId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });

                    const updateResult = await updateResponse.json();

                    if (updateResponse.ok && updateResult.success) {
                        await showSuccess('S√ºr√ºc√º bilgileri ba≈üarƒ±yla g√ºncellendi!');
                        await refreshDriversTable(); // Tabloyu yenile
                    } else {
                        await showError('S√ºr√ºc√º g√ºncellenemedi: ' + (updateResult.error || 'Bilinmeyen hata'));
                    }
                } catch (error) {
                    await showError('S√ºr√ºc√º g√ºncellenirken hata olu≈ütu: ' + error.message);
                }
            }
        } catch (error) {
            await showError('S√ºr√ºc√º bilgileri y√ºklenirken hata olu≈ütu: ' + error.message);
        }
    }

    async function deleteDriver(driverId) {
        const driver = drivers.find(d => d.id === driverId);
        if (!driver) {
            await showError('S√ºr√ºc√º bulunamadƒ±!');
            return;
        }

        // Check if driver is assigned to any buggy
        const assignedBuggy = buggies.find(b => b.driver_id === driverId);
        
        let confirmMessage = `"${driver.full_name || driver.username}" adlƒ± s√ºr√ºc√ºy√º silmek istediƒüinize emin misiniz?`;
        if (assignedBuggy) {
            confirmMessage += `\n\nUYARI: Bu s√ºr√ºc√º "${assignedBuggy.code}" shuttle'ƒ±na atanmƒ±≈ü durumda. S√ºr√ºc√º silinirse atama da kaldƒ±rƒ±lacak.`;
        }

        const confirmed = await BuggyModal.confirm(
            confirmMessage,
            'S√ºr√ºc√º Sil',
            'Evet, Sil',
            'ƒ∞ptal'
        );

        if (!confirmed) return;

        try {
            const response = await fetch(`/api/users/${driverId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok && data.success) {
                await showSuccess('S√ºr√ºc√º ba≈üarƒ±yla silindi!');
                await refreshDriversTable(); // Tabloyu yenile
            } else {
                await showError('S√ºr√ºc√º silinemedi: ' + (data.error || 'Bilinmeyen hata'));
            }
        } catch (error) {
            await showError('S√ºr√ºc√º silinirken hata olu≈ütu: ' + error.message);
        }
    }
</script>

<style>
    /* Responsive optimizasyonlar */
    @media (max-width: 768px) {
        .container {
            padding: 1rem 0.75rem !important;
        }

        .d-flex.justify-between {
            flex-direction: column;
            align-items: stretch !important;
        }

        .d-flex.justify-between h1 {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .d-flex.justify-between > div {
            width: 100%;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }

        /* Table optimize */
        .table-responsive {
            margin: 0 -0.75rem;
            padding: 0 0.75rem;
        }

        .table th,
        .table td {
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        /* Icon s√ºtunu k√º√ß√ºlt */
        .table td:first-child {
            font-size: 1.25rem;
            padding: 0.5rem 0.25rem;
        }

        /* Plaka s√ºtununu gizle */
        .table th:nth-child(3),
        .table td:nth-child(3) {
            display: none;
        }

        /* Action buttons k√º√ß√ºlt */
        .table .btn-sm {
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
        }

        .table .btn-sm i {
            font-size: 0.875rem;
        }

        /* Badge k√º√ß√ºlt */
        .badge {
            font-size: 0.625rem;
            padding: 0.25rem 0.5rem;
        }
    }

    @media (max-width: 480px) {
        .container {
            padding: 0.75rem 0.5rem !important;
        }

        .d-flex.justify-between h1 {
            font-size: 1.25rem;
        }

        .btn-text {
            display: none;
        }

        .btn {
            padding: 0.5rem 0.75rem;
        }

        /* Table daha kompakt */
        .table th,
        .table td {
            padding: 0.375rem 0.25rem;
            font-size: 0.8125rem;
        }

        /* Lokasyon s√ºtununu da gizle */
        .table th:nth-child(5),
        .table td:nth-child(5) {
            display: none;
        }

        /* Action buttons daha k√º√ß√ºk */
        .table .btn-sm {
            padding: 0.25rem 0.375rem;
            margin: 0.125rem;
        }

        .table .btn-sm i {
            font-size: 0.75rem;
        }
    }
</style>
{% endblock %}